<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte OpenStreetMap - Wrapper Iframe [v2.0]</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        /* Panneau de debug */
        #debug-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: rgba(0, 0, 0, 0.95);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 10px;
            overflow-y: auto;
            z-index: 2000;
            border-bottom: 2px solid #00ff00;
        }
        
        #debug-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Iframe contenant la carte */
        #mapFrame {
            position: absolute;
            top: 152px;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: calc(100% - 152px);
            border: none;
            z-index: 1;
        }
        
        /* Indicateur de chargement */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1500;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Contr√¥les de type de carte */
        .map-controls {
            position: absolute;
            top: 162px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .map-controls label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .map-controls select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Panneau de debug -->
    <div id="debug-panel">
        <div id="debug-content"></div>
    </div>
    
    <!-- Indicateur de chargement -->
    <div id="loading">
        <div class="spinner"></div>
        <div>Chargement de la carte...</div>
    </div>
    
    <!-- Contr√¥les de type de carte -->
    <div class="map-controls">
        <label for="mapType">Type de carte:</label>
        <select id="mapType">
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Satellite (Esri)</option>
        </select>
    </div>
    
    <!-- Iframe contenant la vraie carte Leaflet -->
    <iframe id="mapFrame" src="openstreetmap_iframe.html"></iframe>
    
    <script>
        // ========== DEBUG ==========
        function updateDebug(message, color = '#00ff00') {
            const debugContent = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString('fr-FR', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            const line = `[${timestamp}] ${message}\n`;
            debugContent.textContent += line;
            debugContent.parentElement.scrollTop = debugContent.parentElement.scrollHeight;
            console.log(message);
        }
        
        updateDebug('üî∑ [1/3] Page wrapper charg√©e');
        
        // ========== VARIABLES GLOBALES ==========
        var map = null; // R√©f√©rence fictive pour compatibilit√©
        var mapFrame = null;
        var mapAPI = null;
        var markers = [];
        
        // ========== INITIALISATION IFRAME ==========
        window.addEventListener('DOMContentLoaded', function() {
            updateDebug('üî∑ [2/3] DOM pr√™t, attente iframe...');
            
            mapFrame = document.getElementById('mapFrame');
            
            mapFrame.addEventListener('load', function() {
                updateDebug('‚úÖ [3/3] Iframe charg√©e, acc√®s √† l\'API...');
                
                try {
                    // Acc√©der √† l'API de la carte dans l'iframe
                    mapAPI = mapFrame.contentWindow.mapAPI;
                    
                    if (mapAPI) {
                        updateDebug('‚úÖ API carte disponible');
                        
                        // Masquer le loading
                        document.getElementById('loading').style.display = 'none';
                        
                        // Notifier Java que la carte est pr√™te
                        if (window.javaConnector && window.javaConnector.mapReady) {
                            window.javaConnector.mapReady();
                        }
                    } else {
                        updateDebug('‚ùå API carte non disponible', 'red');
                    }
                } catch (e) {
                    updateDebug('‚ùå Erreur acc√®s API: ' + e.message, 'red');
                }
            });
        });
        
        // ========== GESTION DU CHANGEMENT DE TYPE DE CARTE ==========
        document.getElementById('mapType').addEventListener('change', function(e) {
            if (mapAPI) {
                mapAPI.setMapType(e.target.value);
                updateDebug('üó∫Ô∏è Type de carte chang√©: ' + e.target.value);
            }
        });
        
        // ========== API DE COMPATIBILIT√â OPENSTREETMAP/OPENLAYERS ==========
        // Ces fonctions sont appel√©es depuis Java et doivent maintenir la compatibilit√©
        
        /**
         * Initialise la carte (d√©j√† fait par l'iframe, mais gard√© pour compatibilit√©)
         */
        function initializeMap() {
            updateDebug('‚ö†Ô∏è initializeMap() appel√©e (d√©j√† initialis√©e dans iframe)');
            // Ne rien faire, l'iframe g√®re l'initialisation
        }
        
        /**
         * Ajoute un marqueur sur la carte
         */
        function addMarker(lat, lng, title, iconUrl) {
            if (!mapAPI) {
                console.error('API carte non disponible');
                return null;
            }
            
            updateDebug(`üìç Ajout marqueur: [${lat}, ${lng}] "${title}"`);
            return mapAPI.addMarker(lat, lng, title);
        }
        
        // Alias pour compatibilit√©
        window.addMarker = addMarker;
        
        /**
         * Supprime un marqueur
         */
        function removeMarker(index) {
            if (!mapAPI) return;
            updateDebug(`üóëÔ∏è Suppression marqueur ${index}`);
            mapAPI.removeMarker(index);
        }
        
        window.removeMarker = removeMarker;
        
        /**
         * Supprime tous les marqueurs
         */
        function removeAllMarkers() {
            if (!mapAPI) return;
            updateDebug('üóëÔ∏è Suppression tous marqueurs');
            mapAPI.removeAllMarkers();
        }
        
        window.removeAllMarkers = removeAllMarkers;
        
        /**
         * Centre la carte sur une position
         */
        function centerOn(lat, lng, zoom) {
            if (!mapAPI) return;
            updateDebug(`üéØ Centrage sur: [${lat}, ${lng}] zoom=${zoom||'inchang√©'}`);
            mapAPI.centerOn(lat, lng, zoom);
        }
        
        window.centerOn = centerOn;
        
        /**
         * Change le zoom
         */
        function setZoom(level) {
            if (!mapAPI) return;
            updateDebug(`üîç Zoom: ${level}`);
            mapAPI.setZoom(level);
        }
        
        window.setZoom = setZoom;
        
        /**
         * Obtient le centre actuel
         */
        function getCenter() {
            if (!mapAPI) return null;
            return mapAPI.getCenter();
        }
        
        window.getCenter = getCenter;
        
        /**
         * Obtient le zoom actuel
         */
        function getZoom() {
            if (!mapAPI) return null;
            return mapAPI.getZoom();
        }
        
        window.getZoom = getZoom;
        
        /**
         * Change le type de carte
         */
        function setMapType(type) {
            if (!mapAPI) return;
            updateDebug(`üó∫Ô∏è Type carte: ${type}`);
            mapAPI.setMapType(type);
            document.getElementById('mapType').value = type;
        }
        
        window.setMapType = setMapType;
        
        // ========== FONCTIONS DE COMPATIBILIT√â OPENLAYERS ==========
        // Conversion coordonn√©es (simul√©es pour compatibilit√©)
        
        function lon2merc(lon) {
            return lon * 20037508.34 / 180;
        }
        
        function lat2merc(lat) {
            const y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180);
            return y * 20037508.34 / 180;
        }
        
        function merc2lon(x) {
            return x * 180 / 20037508.34;
        }
        
        function merc2lat(y) {
            const lat = y * 180 / 20037508.34;
            return 180 / Math.PI * (2 * Math.atan(Math.exp(lat * Math.PI / 180)) - Math.PI / 2);
        }
        
        window.lon2merc = lon2merc;
        window.lat2merc = lat2merc;
        window.merc2lon = merc2lon;
        window.merc2lat = merc2lat;
        
        /**
         * Va √† une adresse (compatibilit√© OpenLayers)
         */
        function allerAdresse(adresse) {
            updateDebug(`üîç Recherche adresse: ${adresse}`);
            
            // Utiliser l'API Nominatim pour la g√©ocodage
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(adresse)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        updateDebug(`‚úÖ Adresse trouv√©e: [${lat}, ${lng}]`);
                        centerOn(lat, lng, 15);
                    } else {
                        updateDebug(`‚ùå Adresse non trouv√©e: ${adresse}`, 'red');
                    }
                })
                .catch(error => {
                    updateDebug(`‚ùå Erreur g√©ocodage: ${error.message}`, 'red');
                });
        }
        
        window.allerAdresse = allerAdresse;
        
        /**
         * Choix du zoom (compatibilit√© OpenLayers)
         */
        function choixZoom(level) {
            setZoom(level);
        }
        
        window.choixZoom = choixZoom;
        
        /**
         * Ajuste les marqueurs (compatibilit√© OpenLayers)
         */
        function ajusteMarqueurs() {
            updateDebug('‚ö†Ô∏è ajusteMarqueurs() non impl√©ment√© (Leaflet auto-ajuste)');
        }
        
        window.ajusteMarqueurs = ajusteMarqueurs;
        
        /**
         * Affiche un radar (compatibilit√© OpenLayers)
         */
        function afficheRadar(lat, lng, radius, color) {
            updateDebug(`‚ö†Ô∏è afficheRadar() non impl√©ment√©: [${lat}, ${lng}] r=${radius}`);
            // TODO: Impl√©menter avec L.circle si n√©cessaire
        }
        
        window.afficheRadar = afficheRadar;
        
        /**
         * Retire le radar (compatibilit√© OpenLayers)
         */
        function retireRadar() {
            updateDebug('‚ö†Ô∏è retireRadar() non impl√©ment√©');
        }
        
        window.retireRadar = retireRadar;
        
        /**
         * Valide la cl√© API Bing (compatibilit√©, non utilis√© avec OSM)
         */
        function valideBingApiKey() {
            updateDebug('‚ö†Ô∏è valideBingApiKey() appel√©e (non utilis√© avec OSM)');
            return true;
        }
        
        window.valideBingApiKey = valideBingApiKey;
        
        /**
         * Retourne les noms des couches disponibles (compatibilit√© OpenLayers)
         */
        function getNomsLayers() {
            return "OpenStreetMap,Satellite";
        }
        
        window.getNomsLayers = getNomsLayers;
        
        updateDebug('‚úÖ API de compatibilit√© charg√©e');
    </script>
</body>
</html>
