<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte OpenStreetMap - Leaflet</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* Debug panel - MASQUÃ‰ EN PRODUCTION */
        #debugPanel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            display: none; /* MASQUÃ‰ EN PRODUCTION */
            padding: 10px;
            overflow-y: auto;
            z-index: 10000;
            border-bottom: 2px solid #00ff00;
        }
        
        #debugPanel h3 {
            color: #00ffff;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        #debugContent {
            line-height: 1.4;
        }
        
        .debug-timestamp {
            color: #888;
            margin-right: 5px;
        }
        
        .debug-success {
            color: #00ff00;
        }
        
        .debug-error {
            color: #ff0000;
        }
        
        .debug-info {
            color: #ffaa00;
        }
        
        /* Map container */
        #map {
            position: absolute;
            top: 0; /* Plein Ã©cran, debug panel masquÃ© */
            left: 0;
            right: 0;
            bottom: 0;
            background: #f0f0f0;
        }
        
        /* Loading indicator */
        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 18px;
            color: #333;
            z-index: 9999;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div id="debugPanel">
        <h3>ğŸ” Debug Console - Carte Leaflet UnifiÃ©e</h3>
        <div id="debugContent"></div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator">
        <div class="spinner"></div>
        <div>Chargement de la carte...</div>
    </div>
    
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Leaflet JS -->
    <script src="libs/leaflet/leaflet.js"></script>
    
    <script>
        // Debug logging function
        let debugCounter = 0;
        function updateDebug(message, type = 'info') {
            debugCounter++;
            const timestamp = new Date().toLocaleTimeString('fr-FR', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            
            const debugContent = document.getElementById('debugContent');
            const line = document.createElement('div');
            
            let icon = 'ğŸ“‹';
            let className = 'debug-info';
            if (type === 'success') {
                icon = 'âœ…';
                className = 'debug-success';
            } else if (type === 'error') {
                icon = 'âŒ';
                className = 'debug-error';
            } else if (type === 'warn') {
                icon = 'âš ï¸';
                className = 'debug-info';
            }
            
            line.className = className;
            line.innerHTML = `<span class="debug-timestamp">[${timestamp}]</span> ${icon} ${message}`;
            debugContent.appendChild(line);
            
            // Auto-scroll to bottom
            debugContent.scrollTop = debugContent.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Map and markers
        var map = null;
        var markers = [];
        var currentMapType = 'osm';
        var currentMarker = null; // Alias pour searchMarker (compatibilitÃ©)
        
        // Tile layers configuration
        const tileLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            })
        };
        
        // Initialize map
        function initMap() {
            try {
                updateDebug('Initialisation de la carte Leaflet...', 'info');
                
                // Create map with SVG renderer for better compatibility
                map = L.map('map', {
                    center: [48.8566, 2.3522], // Paris par dÃ©faut
                    zoom: 13,
                    preferCanvas: false,
                    renderer: L.svg()
                });
                
                updateDebug('Instance L.map() crÃ©Ã©e', 'success');
                
                // Add default tile layer
                tileLayers.osm.addTo(map);
                updateDebug('Couche OSM ajoutÃ©e', 'success');
                
                // Force map invalidation after a short delay
                setTimeout(() => {
                    map.invalidateSize();
                    updateDebug('invalidateSize() appelÃ©', 'success');
                }, 100);
                
                // Hide loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                    updateDebug('Indicateur de chargement masquÃ©', 'success');
                }
                
                updateDebug('âœ… Carte initialisÃ©e avec succÃ¨s!', 'success');
                
                // Notify Java that map is ready
                if (window.javaConnector) {
                    window.javaConnector.mapReady();
                }
                
            } catch (error) {
                updateDebug('Erreur initialisation: ' + error.message, 'error');
                console.error('Map initialization error:', error);
            }
        }
        
        // API Functions for Java compatibility
        
        function addMarker(lat, lng, title) {
            try {
                if (!map) {
                    updateDebug('addMarker: carte non initialisÃ©e', 'warn');
                    return -1;
                }
                
                const marker = L.marker([lat, lng]);
                if (title) {
                    marker.bindPopup(title);
                }
                marker.addTo(map);
                markers.push(marker);
                
                updateDebug(`Marqueur ajoutÃ©: [${lat}, ${lng}] - "${title}"`, 'success');
                return markers.length - 1;
            } catch (error) {
                updateDebug('Erreur addMarker: ' + error.message, 'error');
                return -1;
            }
        }
        
        function removeMarker(index) {
            try {
                if (index >= 0 && index < markers.length && markers[index]) {
                    map.removeLayer(markers[index]);
                    markers[index] = null;
                    updateDebug(`Marqueur ${index} supprimÃ©`, 'success');
                }
            } catch (error) {
                updateDebug('Erreur removeMarker: ' + error.message, 'error');
            }
        }
        
        function removeAllMarkers() {
            try {
                markers.forEach((marker, index) => {
                    if (marker) {
                        map.removeLayer(marker);
                    }
                });
                markers = [];
                updateDebug('Tous les marqueurs supprimÃ©s', 'success');
            } catch (error) {
                updateDebug('Erreur removeAllMarkers: ' + error.message, 'error');
            }
        }
        
        /**
         * RÃ©cupÃ¨re la position d'un marqueur par son index
         * @param {number} index - Index du marqueur dans le tableau markers
         * @returns {Object|null} - Objet {lat, lng} ou null si le marqueur n'existe pas
         */
        function getMarkerPosition(index) {
            try {
                if (index >= 0 && index < markers.length && markers[index]) {
                    const position = markers[index].getLatLng();
                    updateDebug(`ğŸ“ Position marqueur ${index}: [${position.lat}, ${position.lng}]`, 'info');
                    return {lat: position.lat, lng: position.lng};
                } else {
                    updateDebug(`âš ï¸ Marqueur ${index} non trouvÃ©`, 'warn');
                    return null;
                }
            } catch (error) {
                updateDebug('âŒ Erreur getMarkerPosition: ' + error.message, 'error');
                console.error('getMarkerPosition error:', error);
                return null;
            }
        }
        
        // Fonction ajouteMarqueur pour compatibilitÃ© Java
        // ParamÃ¨tres: index, longitude, latitude, htmlContent
        function ajouteMarqueur(index, lng, lat, htmlContent) {
            try {
                if (!map) {
                    updateDebug('ajouteMarqueur: carte non initialisÃ©e', 'warn');
                    return;
                }
                
                // Supprimer le marqueur de recherche (searchMarker) s'il existe
                if (searchMarker) {
                    updateDebug('ğŸ—‘ï¸ Suppression searchMarker existant', 'info');
                    map.removeLayer(searchMarker);
                    searchMarker = null;
                    currentMarker = null;
                }
                
                // Supprimer le marqueur existant Ã  cet index si prÃ©sent
                if (index >= 0 && index < markers.length && markers[index]) {
                    map.removeLayer(markers[index]);
                    markers[index] = null;
                }
                
                // CrÃ©er le nouveau marqueur DRAGGABLE avec les coordonnÃ©es correctes
                const marker = L.marker([lat, lng], {
                    draggable: true,
                    autoPan: true
                });
                
                // Ã‰vÃ©nement de drag pour mettre Ã  jour les coordonnÃ©es
                marker.on('dragend', function(event) {
                    const position = marker.getLatLng();
                    updateDebug(`ğŸ“ Marqueur ${index} dÃ©placÃ©: ${position.lat}, ${position.lng}`, 'info');
                    
                    // Notifier Java des nouvelles coordonnÃ©es
                    if (window.javafx) {
                        window.javafx.majMarqueur(index, position.lng, position.lat);
                    } else if (window.javaConnector) {
                        window.javaConnector.majMarqueur(index, position.lng, position.lat);
                    }
                });
                
                // Ajouter le popup HTML si fourni
                if (htmlContent) {
                    marker.bindPopup(htmlContent);
                }
                
                // Ajouter le marqueur Ã  la carte
                marker.addTo(map);
                
                // Stocker le marqueur dans le tableau Ã  l'index spÃ©cifiÃ©
                if (index >= markers.length) {
                    // Ã‰tendre le tableau si nÃ©cessaire
                    markers.length = index + 1;
                }
                markers[index] = marker;
                
                updateDebug(`âœ… ajouteMarqueur[${index}]: [${lat}, ${lng}] - "${htmlContent}"`, 'success');
            } catch (error) {
                updateDebug('âŒ Erreur ajouteMarqueur: ' + error.message, 'error');
                console.error('ajouteMarqueur error:', error);
            }
        }
        
        /**
         * Supprime un marqueur par son index
         */
        function enleveMarqueur(index) {
            try {
                if (!map) {
                    updateDebug('enleveMarqueur: carte non initialisÃ©e', 'warn');
                    return;
                }
                
                // Supprimer le marqueur de recherche (searchMarker) s'il existe
                if (searchMarker) {
                    updateDebug(`ğŸ—‘ï¸ Suppression searchMarker`, 'info');
                    map.removeLayer(searchMarker);
                    searchMarker = null;
                    currentMarker = null;
                }
                
                // Supprimer le marqueur Ã  l'index spÃ©cifiÃ©
                if (index >= 0 && index < markers.length && markers[index]) {
                    updateDebug(`ğŸ—‘ï¸ Suppression marqueur[${index}]`, 'info');
                    map.removeLayer(markers[index]);
                    markers[index] = null;
                }
                
                updateDebug(`âœ… enleveMarqueur[${index}] terminÃ©`, 'success');
            } catch (error) {
                updateDebug('âŒ Erreur enleveMarqueur: ' + error.message, 'error');
                console.error('enleveMarqueur error:', error);
            }
        }
        
        function centerOn(lat, lng, zoom) {
            try {
                if (!map) {
                    updateDebug('centerOn: carte non initialisÃ©e', 'warn');
                    return;
                }
                
                const targetZoom = zoom !== undefined ? zoom : map.getZoom();
                map.setView([lat, lng], targetZoom);
                updateDebug(`Centrage: [${lat}, ${lng}] zoom=${targetZoom}`, 'success');
            } catch (error) {
                updateDebug('Erreur centerOn: ' + error.message, 'error');
            }
        }
        
        function setMapType(type) {
            try {
                if (!map) {
                    updateDebug('setMapType: carte non initialisÃ©e', 'warn');
                    return;
                }
                
                // Remove current layer
                if (currentMapType && tileLayers[currentMapType]) {
                    map.removeLayer(tileLayers[currentMapType]);
                }
                
                // Add new layer
                const newType = type.toLowerCase() === 'satellite' ? 'satellite' : 'osm';
                if (tileLayers[newType]) {
                    tileLayers[newType].addTo(map);
                    currentMapType = newType;
                    updateDebug(`Type de carte changÃ©: ${newType}`, 'success');
                }
            } catch (error) {
                updateDebug('Erreur setMapType: ' + error.message, 'error');
            }
        }
        
        function setZoom(level) {
            try {
                if (!map) {
                    updateDebug('setZoom: carte non initialisÃ©e', 'warn');
                    return;
                }
                
                map.setZoom(level);
                updateDebug(`Zoom dÃ©fini: ${level}`, 'success');
            } catch (error) {
                updateDebug('Erreur setZoom: ' + error.message, 'error');
            }
        }
        
        function getCenter() {
            try {
                if (!map) return { lat: 0, lng: 0 };
                const center = map.getCenter();
                return { lat: center.lat, lng: center.lng };
            } catch (error) {
                updateDebug('Erreur getCenter: ' + error.message, 'error');
                return { lat: 0, lng: 0 };
            }
        }
        
        function getZoom() {
            try {
                if (!map) return 13;
                return map.getZoom();
            } catch (error) {
                return 13;
            }
        }
        
        // Variable pour stocker le marqueur de recherche
        var searchMarker = null;
        
        // Compatibility function for OpenLayers API
        function allerAdresse(address) {
            updateDebug('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            updateDebug('ğŸ” DÃ‰BUT allerAdresse()', 'info');
            updateDebug(`ğŸ“ Adresse reÃ§ue: "${address}"`, 'info');
            
            try {
                // VÃ©rifier que la carte est initialisÃ©e
                if (!map) {
                    updateDebug('âŒ ERREUR: Carte non initialisÃ©e!', 'error');
                    return;
                }
                updateDebug('âœ… Carte initialisÃ©e', 'success');
                
                // Supprimer le marqueur existant (index 0)
                updateDebug('ğŸ—‘ï¸ Suppression marqueur existant (index 0)...', 'info');
                enleveMarqueur(0);
                
                // Use LocationIQ geocoding service (free tier: 5000 requests/day)
                // ClÃ© API gratuite pour dÃ©mo - Remplacer par votre propre clÃ© en production
                const apiKey = 'pk.0f147952a41c555a5b70614039fd148b';
                const url = `https://us1.locationiq.com/v1/search.php?key=${apiKey}&q=${encodeURIComponent(address)}&format=json`;
                
                updateDebug(`ğŸŒ URL API: ${url}`, 'info');
                updateDebug('ğŸ“¡ Envoi requÃªte fetch()...', 'info');
                
                fetch(url)
                    .then(response => {
                        updateDebug(`ğŸ“¨ RÃ©ponse reÃ§ue: HTTP ${response.status}`, response.ok ? 'success' : 'error');
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                        }
                        
                        updateDebug('ğŸ”„ Parsing JSON...', 'info');
                        return response.json();
                    })
                    .then(data => {
                        updateDebug(`ğŸ“¦ DonnÃ©es reÃ§ues: ${JSON.stringify(data).substring(0, 200)}...`, 'info');
                        updateDebug(`ğŸ“Š Nombre de rÃ©sultats: ${data ? data.length : 0}`, 'info');
                        
                        if (data && data.length > 0) {
                            const result = data[0];
                            const lat = parseFloat(result.lat);
                            const lng = parseFloat(result.lon);
                            
                            updateDebug(`ğŸ“ CoordonnÃ©es trouvÃ©es: Lat=${lat}, Lng=${lng}`, 'success');
                            updateDebug(`ğŸ“ Lieu: ${result.display_name}`, 'info');
                            
                            // Centrer la carte
                            updateDebug('ğŸ—ºï¸ Appel centerOn()...', 'info');
                            centerOn(lat, lng, 15);
                            updateDebug('âœ… centerOn() terminÃ©', 'success');
                            
                            // Supprimer l'ancien marqueur de recherche s'il existe
                            if (searchMarker) {
                                updateDebug('ğŸ—‘ï¸ Suppression ancien marqueur', 'info');
                                map.removeLayer(searchMarker);
                            }
                            
                            // CrÃ©er un marqueur dÃ©plaÃ§able
                            updateDebug('ğŸ“Œ CrÃ©ation marqueur dÃ©plaÃ§able...', 'info');
                            searchMarker = L.marker([lat, lng], {
                                draggable: true,
                                title: result.display_name
                            }).addTo(map);
                            currentMarker = searchMarker; // Alias pour compatibilitÃ©
                            updateDebug('âœ… Marqueur crÃ©Ã© et ajoutÃ© Ã  la carte', 'success');
                            
                            // Ajouter un popup
                            searchMarker.bindPopup(`
                                <b>${result.display_name}</b><br>
                                Lat: ${lat.toFixed(6)}<br>
                                Lng: ${lng.toFixed(6)}<br>
                                <small>Glissez le marqueur pour affiner la position</small>
                            `).openPopup();
                            updateDebug('âœ… Popup configurÃ©', 'success');
                            
                            // Ã‰vÃ©nement de dÃ©placement du marqueur
                            searchMarker.on('dragend', function(event) {
                                const position = event.target.getLatLng();
                                updateDebug(`ğŸ“ Marqueur dÃ©placÃ©: Lat=${position.lat}, Lng=${position.lng}`, 'info');
                                updateCoordinates(position.lat, position.lng);
                                
                                // Mettre Ã  jour le popup
                                searchMarker.setPopupContent(`
                                    <b>Position affinÃ©e</b><br>
                                    Lat: ${position.lat.toFixed(6)}<br>
                                    Lng: ${position.lng.toFixed(6)}
                                `);
                            });
                            updateDebug('âœ… Ã‰vÃ©nement dragend configurÃ©', 'success');
                            
                            // Mettre Ã  jour les coordonnÃ©es dans Java
                            updateDebug('â˜• Appel updateCoordinates()...', 'info');
                            updateCoordinates(lat, lng);
                            
                            updateDebug('âœ… âœ… âœ… SUCCÃˆS COMPLET!', 'success');
                        } else {
                            updateDebug('âš ï¸ Aucun rÃ©sultat trouvÃ©', 'warn');
                        }
                    })
                    .catch(error => {
                        updateDebug(`âŒ ERREUR fetch: ${error.message}`, 'error');
                        updateDebug(`âŒ Stack: ${error.stack}`, 'error');
                        console.error('LocationIQ geocoding error:', error);
                    });
                    
                updateDebug('ğŸ”š FIN allerAdresse() (attente rÃ©ponse async)', 'info');
                
            } catch (error) {
                updateDebug(`âŒ EXCEPTION dans allerAdresse: ${error.message}`, 'error');
                updateDebug(`âŒ Stack: ${error.stack}`, 'error');
            }
        }
        
        // Fonction pour notifier Java des nouvelles coordonnÃ©es
        function updateCoordinates(lat, lng) {
            updateDebug('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');
            updateDebug('â˜• DÃ‰BUT updateCoordinates()', 'info');
            updateDebug(`ğŸ“ ParamÃ¨tres: Lat=${lat}, Lng=${lng}`, 'info');
            
            try {
                // VÃ©rifier l'existence du connecteur Java
                updateDebug(`ğŸ” window.javaConnector existe? ${!!window.javaConnector}`, 'info');
                
                if (window.javaConnector) {
                    updateDebug(`ğŸ” javaConnector.updateCoordinates existe? ${typeof window.javaConnector.updateCoordinates}`, 'info');
                    
                    if (typeof window.javaConnector.updateCoordinates === 'function') {
                        updateDebug(`â˜• Appel javaConnector.updateCoordinates(${lng}, ${lat})...`, 'info');
                        window.javaConnector.updateCoordinates(lng, lat); // longitude, latitude
                        updateDebug('âœ… CoordonnÃ©es envoyÃ©es Ã  Java avec succÃ¨s!', 'success');
                    } else {
                        updateDebug('âŒ javaConnector.updateCoordinates n\'est pas une fonction!', 'error');
                    }
                } else {
                    updateDebug('âŒ window.javaConnector n\'existe pas!', 'error');
                    updateDebug('ğŸ’¡ Le pont Java n\'est pas configurÃ©', 'warn');
                }
            } catch (error) {
                updateDebug(`âŒ ERREUR updateCoordinates: ${error.message}`, 'error');
                updateDebug(`âŒ Stack: ${error.stack}`, 'error');
            }
            
            updateDebug('ğŸ”š FIN updateCoordinates()', 'info');
        }
        
        function choixZoom(level) {
            setZoom(level);
        }
        
        function getNomsLayers() {
            // Retourne les noms des couches disponibles avec | comme sÃ©parateur
            // Le * indique la couche active
            if (currentMapType === 'osm') {
                return "*OpenStreetMap|Satellite";
            } else {
                return "OpenStreetMap|*Satellite";
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RADAR (Champ de vision)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let radarLayer = null; // Layer pour le radar (champ de vision)
        
        /**
         * Affiche un radar (champ de vision) sur la carte
         * @param {number} lat - Latitude du centre
         * @param {number} lng - Longitude du centre
         * @param {number} angle - Angle de direction en degrÃ©s (0 = Nord)
         * @param {number} fov - Ouverture du champ de vision en degrÃ©s
         * @param {number} radius - Rayon en mÃ¨tres
         * @param {string} strokeColor - Couleur de la bordure (#RRGGBB)
         * @param {string} fillColor - Couleur de remplissage (#RRGGBB)
         * @param {number} opacity - OpacitÃ© (0-1)
         */
        function afficheRadar(lat, lng, angle, fov, radius, strokeColor, fillColor, opacity) {
            updateDebug(`ğŸ“¡ afficheRadar(${lat}, ${lng}, angle=${angle}Â°, FOV=${fov}Â°, radius=${radius}m)`, 'info');
            
            try {
                // Retirer l'ancien radar si existant
                retireRadar();
                
                // Convertir l'angle (0Â° = Nord) en radians
                const angleRad = (angle - 90) * Math.PI / 180; // -90 car 0Â° = Est en math
                const fovRad = fov * Math.PI / 180;
                
                // Calculer les angles de dÃ©but et fin de l'arc
                const startAngle = angleRad - fovRad / 2;
                const endAngle = angleRad + fovRad / 2;
                
                // CrÃ©er les points de l'arc
                const points = [[lat, lng]]; // Commencer au centre
                
                // Nombre de segments pour l'arc
                const segments = Math.max(20, Math.ceil(fov / 5));
                
                // GÃ©nÃ©rer les points de l'arc
                for (let i = 0; i <= segments; i++) {
                    const currentAngle = startAngle + (endAngle - startAngle) * i / segments;
                    
                    // Calculer la distance en degrÃ©s (approximation simple)
                    const radiusInDegrees = radius / 111320; // ~111320m par degrÃ© de latitude
                    
                    const pointLat = lat + radiusInDegrees * Math.sin(currentAngle);
                    const pointLng = lng + radiusInDegrees * Math.cos(currentAngle) / Math.cos(lat * Math.PI / 180);
                    
                    points.push([pointLat, pointLng]);
                }
                
                // Fermer le polygone en revenant au centre
                points.push([lat, lng]);
                
                // CrÃ©er le polygone Leaflet
                radarLayer = L.polygon(points, {
                    color: strokeColor,
                    fillColor: fillColor,
                    fillOpacity: opacity,
                    weight: 2,
                    interactive: false // Le radar ne doit pas intercepter les clics
                }).addTo(map);
                
                updateDebug(`âœ… Radar affichÃ© avec ${segments} segments`, 'success');
                
            } catch (error) {
                updateDebug(`âŒ Erreur afficheRadar: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        /**
         * Retire le radar de la carte
         */
        function retireRadar() {
            if (radarLayer) {
                try {
                    map.removeLayer(radarLayer);
                    radarLayer = null;
                    updateDebug('âœ… Radar retirÃ©', 'info');
                } catch (error) {
                    updateDebug(`âŒ Erreur retireRadar: ${error.message}`, 'error');
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALISATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Initialize when DOM is ready
        updateDebug('[1/2] DOM chargÃ©, initialisation Leaflet...', 'info');
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateDebug('[2/2] DOMContentLoaded dÃ©clenchÃ©', 'success');
                initMap();
            });
        } else {
            updateDebug('[2/2] DOM dÃ©jÃ  prÃªt', 'success');
            initMap();
        }
    </script>
</body>
</html>
