<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte OpenStreetMap - Leaflet</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* Debug panel - MASQU√â EN PRODUCTION */
        #debugPanel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            display: none; /* MASQU√â EN PRODUCTION */
            padding: 10px;
            overflow-y: auto;
            z-index: 10000;
            border-bottom: 2px solid #00ff00;
        }
        
        #debugPanel h3 {
            color: #00ffff;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        #debugContent {
            line-height: 1.4;
        }
        
        .debug-timestamp {
            color: #888;
            margin-right: 5px;
        }
        
        .debug-success {
            color: #00ff00;
        }
        
        .debug-error {
            color: #ff0000;
        }
        
        .debug-info {
            color: #ffaa00;
        }
        
        /* Map container */
        #map {
            position: absolute;
            top: 0; /* Plein √©cran, debug panel masqu√© */
            left: 0;
            right: 0;
            bottom: 0;
            background: #f0f0f0;
        }
        
        /* Loading indicator */
        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 18px;
            color: #333;
            z-index: 9999;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div id="debugPanel">
        <h3>üîç Debug Console - Carte Leaflet Unifi√©e</h3>
        <div id="debugContent"></div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator">
        <div class="spinner"></div>
        <div>Chargement de la carte...</div>
    </div>
    
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Leaflet JS -->
    <script src="libs/leaflet/leaflet.js"></script>
    
    <script>
        // Debug logging function
        let debugCounter = 0;
        function updateDebug(message, type = 'info') {
            debugCounter++;
            const timestamp = new Date().toLocaleTimeString('fr-FR', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            
            const debugContent = document.getElementById('debugContent');
            const line = document.createElement('div');
            
            let icon = 'üìã';
            let className = 'debug-info';
            if (type === 'success') {
                icon = '‚úÖ';
                className = 'debug-success';
            } else if (type === 'error') {
                icon = '‚ùå';
                className = 'debug-error';
            } else if (type === 'warn') {
                icon = '‚ö†Ô∏è';
                className = 'debug-info';
            }
            
            line.className = className;
            line.innerHTML = `<span class="debug-timestamp">[${timestamp}]</span> ${icon} ${message}`;
            debugContent.appendChild(line);
            
            // Auto-scroll to bottom
            debugContent.scrollTop = debugContent.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Map and markers
        var map = null;
        var markers = [];
        var currentMapType = 'osm';
        var currentMarker = null; // Alias pour searchMarker (compatibilit√©)
        
        // Tile layers configuration
        const tileLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            })
        };
        
        // Initialize map
        function initMap() {
            try {
                updateDebug('Initialisation de la carte Leaflet...', 'info');
                
                // Create map with SVG renderer for better compatibility
                map = L.map('map', {
                    center: [48.8566, 2.3522], // Paris par d√©faut
                    zoom: 13,
                    preferCanvas: false,
                    renderer: L.svg()
                });
                
                updateDebug('Instance L.map() cr√©√©e', 'success');
                
                // Add default tile layer
                tileLayers.osm.addTo(map);
                updateDebug('Couche OSM ajout√©e', 'success');
                
                // Force map invalidation after a short delay
                setTimeout(() => {
                    map.invalidateSize();
                    updateDebug('invalidateSize() appel√©', 'success');
                }, 100);
                
                // Hide loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                    updateDebug('Indicateur de chargement masqu√©', 'success');
                }
                
                updateDebug('‚úÖ Carte initialis√©e avec succ√®s!', 'success');
                
                // Notify Java that map is ready
                if (window.javaConnector) {
                    window.javaConnector.mapReady();
                }
                
            } catch (error) {
                updateDebug('Erreur initialisation: ' + error.message, 'error');
                console.error('Map initialization error:', error);
            }
        }
        
        // API Functions for Java compatibility
        
        function addMarker(lat, lng, title) {
            try {
                if (!map) {
                    updateDebug('addMarker: carte non initialis√©e', 'warn');
                    return -1;
                }
                
                const marker = L.marker([lat, lng]);
                if (title) {
                    marker.bindPopup(title);
                }
                marker.addTo(map);
                markers.push(marker);
                
                updateDebug(`Marqueur ajout√©: [${lat}, ${lng}] - "${title}"`, 'success');
                return markers.length - 1;
            } catch (error) {
                updateDebug('Erreur addMarker: ' + error.message, 'error');
                return -1;
            }
        }
        
        function removeMarker(index) {
            try {
                if (index >= 0 && index < markers.length && markers[index]) {
                    map.removeLayer(markers[index]);
                    markers[index] = null;
                    updateDebug(`Marqueur ${index} supprim√©`, 'success');
                }
            } catch (error) {
                updateDebug('Erreur removeMarker: ' + error.message, 'error');
            }
        }
        
        function removeAllMarkers() {
            try {
                markers.forEach((marker, index) => {
                    if (marker) {
                        map.removeLayer(marker);
                    }
                });
                markers = [];
                updateDebug('Tous les marqueurs supprim√©s', 'success');
            } catch (error) {
                updateDebug('Erreur removeAllMarkers: ' + error.message, 'error');
            }
        }
        
        /**
         * R√©cup√®re la position d'un marqueur par son index
         * @param {number} index - Index du marqueur dans le tableau markers
         * @returns {Object|null} - Objet {lat, lng} ou null si le marqueur n'existe pas
         */
        function getMarkerPosition(index) {
            try {
                if (index >= 0 && index < markers.length && markers[index]) {
                    const position = markers[index].getLatLng();
                    updateDebug(`üìç Position marqueur ${index}: [${position.lat}, ${position.lng}]`, 'info');
                    return {lat: position.lat, lng: position.lng};
                } else {
                    updateDebug(`‚ö†Ô∏è Marqueur ${index} non trouv√©`, 'warn');
                    return null;
                }
            } catch (error) {
                updateDebug('‚ùå Erreur getMarkerPosition: ' + error.message, 'error');
                console.error('getMarkerPosition error:', error);
                return null;
            }
        }
        
        // Fonction ajouteMarqueur pour compatibilit√© Java
        // Param√®tres: index, longitude, latitude, htmlContent
        function ajouteMarqueur(index, lng, lat, htmlContent) {
            try {
                if (!map) {
                    updateDebug('ajouteMarqueur: carte non initialis√©e', 'warn');
                    return;
                }
                
                // Supprimer le marqueur de recherche (searchMarker) s'il existe
                if (searchMarker) {
                    updateDebug('üóëÔ∏è Suppression searchMarker existant', 'info');
                    map.removeLayer(searchMarker);
                    searchMarker = null;
                    currentMarker = null;
                }
                
                // Supprimer le marqueur existant √† cet index si pr√©sent
                if (index >= 0 && index < markers.length && markers[index]) {
                    map.removeLayer(markers[index]);
                    markers[index] = null;
                }
                
                // Cr√©er le nouveau marqueur DRAGGABLE avec les coordonn√©es correctes
                const marker = L.marker([lat, lng], {
                    draggable: true,
                    autoPan: true
                });
                
                // √âv√©nement de drag pour mettre √† jour les coordonn√©es
                marker.on('dragend', function(event) {
                    const position = marker.getLatLng();
                    updateDebug(`üìç Marqueur ${index} d√©plac√©: ${position.lat}, ${position.lng}`, 'info');
                    
                    // Notifier Java des nouvelles coordonn√©es
                    if (window.javafx) {
                        window.javafx.majMarqueur(index, position.lng, position.lat);
                    } else if (window.javaConnector) {
                        window.javaConnector.majMarqueur(index, position.lng, position.lat);
                    }
                });
                
                // Ajouter le popup HTML si fourni
                if (htmlContent) {
                    marker.bindPopup(htmlContent);
                }
                
                // Ajouter le marqueur √† la carte
                marker.addTo(map);
                
                // Stocker le marqueur dans le tableau √† l'index sp√©cifi√©
                if (index >= markers.length) {
                    // √âtendre le tableau si n√©cessaire
                    markers.length = index + 1;
                }
                markers[index] = marker;
                
                updateDebug(`‚úÖ ajouteMarqueur[${index}]: [${lat}, ${lng}] - "${htmlContent}"`, 'success');
            } catch (error) {
                updateDebug('‚ùå Erreur ajouteMarqueur: ' + error.message, 'error');
                console.error('ajouteMarqueur error:', error);
            }
        }
        
        /**
         * Supprime un marqueur par son index
         */
        function enleveMarqueur(index) {
            try {
                if (!map) {
                    updateDebug('enleveMarqueur: carte non initialis√©e', 'warn');
                    return;
                }
                
                // Supprimer le marqueur de recherche (searchMarker) s'il existe
                if (searchMarker) {
                    updateDebug(`üóëÔ∏è Suppression searchMarker`, 'info');
                    map.removeLayer(searchMarker);
                    searchMarker = null;
                    currentMarker = null;
                }
                
                // Supprimer le marqueur √† l'index sp√©cifi√©
                if (index >= 0 && index < markers.length && markers[index]) {
                    updateDebug(`üóëÔ∏è Suppression marqueur[${index}]`, 'info');
                    map.removeLayer(markers[index]);
                    markers[index] = null;
                }
                
                updateDebug(`‚úÖ enleveMarqueur[${index}] termin√©`, 'success');
            } catch (error) {
                updateDebug('‚ùå Erreur enleveMarqueur: ' + error.message, 'error');
                console.error('enleveMarqueur error:', error);
            }
        }
        
        function centerOn(lat, lng, zoom) {
            try {
                if (!map) {
                    updateDebug('centerOn: carte non initialis√©e', 'warn');
                    return;
                }
                
                const targetZoom = zoom !== undefined ? zoom : map.getZoom();
                map.setView([lat, lng], targetZoom);
                updateDebug(`Centrage: [${lat}, ${lng}] zoom=${targetZoom}`, 'success');
            } catch (error) {
                updateDebug('Erreur centerOn: ' + error.message, 'error');
            }
        }
        
        function setMapType(type) {
            try {
                if (!map) {
                    updateDebug('setMapType: carte non initialis√©e', 'warn');
                    return;
                }
                
                // Remove current layer
                if (currentMapType && tileLayers[currentMapType]) {
                    map.removeLayer(tileLayers[currentMapType]);
                }
                
                // Add new layer
                const newType = type.toLowerCase() === 'satellite' ? 'satellite' : 'osm';
                if (tileLayers[newType]) {
                    tileLayers[newType].addTo(map);
                    currentMapType = newType;
                    updateDebug(`Type de carte chang√©: ${newType}`, 'success');
                }
            } catch (error) {
                updateDebug('Erreur setMapType: ' + error.message, 'error');
            }
        }
        
        function setZoom(level) {
            try {
                if (!map) {
                    updateDebug('setZoom: carte non initialis√©e', 'warn');
                    return;
                }
                
                map.setZoom(level);
                updateDebug(`Zoom d√©fini: ${level}`, 'success');
            } catch (error) {
                updateDebug('Erreur setZoom: ' + error.message, 'error');
            }
        }
        
        function getCenter() {
            try {
                if (!map) return { lat: 0, lng: 0 };
                const center = map.getCenter();
                return { lat: center.lat, lng: center.lng };
            } catch (error) {
                updateDebug('Erreur getCenter: ' + error.message, 'error');
                return { lat: 0, lng: 0 };
            }
        }
        
        function getZoom() {
            try {
                if (!map) return 13;
                return map.getZoom();
            } catch (error) {
                return 13;
            }
        }
        
        // Variable pour stocker le marqueur de recherche
        var searchMarker = null;
        
        // Compatibility function for OpenLayers API
        function allerAdresse(address) {
            updateDebug('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            updateDebug('üîç D√âBUT allerAdresse()', 'info');
            updateDebug(`üìç Adresse re√ßue: "${address}"`, 'info');
            
            try {
                // V√©rifier que la carte est initialis√©e
                if (!map) {
                    updateDebug('‚ùå ERREUR: Carte non initialis√©e!', 'error');
                    return;
                }
                updateDebug('‚úÖ Carte initialis√©e', 'success');
                
                // Supprimer le marqueur existant (index 0)
                updateDebug('üóëÔ∏è Suppression marqueur existant (index 0)...', 'info');
                enleveMarqueur(0);
                
                // Use LocationIQ geocoding service (free tier: 5000 requests/day)
                // Cl√© API gratuite pour d√©mo - Remplacer par votre propre cl√© en production
                const apiKey = 'pk.0f147952a41c555a5b70614039fd148b';
                const url = `https://us1.locationiq.com/v1/search.php?key=${apiKey}&q=${encodeURIComponent(address)}&format=json`;
                
                updateDebug(`üåê URL API: ${url}`, 'info');
                updateDebug('üì° Envoi requ√™te fetch()...', 'info');
                
                fetch(url)
                    .then(response => {
                        updateDebug(`üì® R√©ponse re√ßue: HTTP ${response.status}`, response.ok ? 'success' : 'error');
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                        }
                        
                        updateDebug('üîÑ Parsing JSON...', 'info');
                        return response.json();
                    })
                    .then(data => {
                        updateDebug(`üì¶ Donn√©es re√ßues: ${JSON.stringify(data).substring(0, 200)}...`, 'info');
                        updateDebug(`üìä Nombre de r√©sultats: ${data ? data.length : 0}`, 'info');
                        
                        if (data && data.length > 0) {
                            const result = data[0];
                            const lat = parseFloat(result.lat);
                            const lng = parseFloat(result.lon);
                            
                            updateDebug(`üìç Coordonn√©es trouv√©es: Lat=${lat}, Lng=${lng}`, 'success');
                            updateDebug(`üìù Lieu: ${result.display_name}`, 'info');
                            
                            // Centrer la carte
                            updateDebug('üó∫Ô∏è Appel centerOn()...', 'info');
                            centerOn(lat, lng, 15);
                            updateDebug('‚úÖ centerOn() termin√©', 'success');
                            
                            // Supprimer l'ancien marqueur de recherche s'il existe
                            if (searchMarker) {
                                updateDebug('üóëÔ∏è Suppression ancien marqueur', 'info');
                                map.removeLayer(searchMarker);
                            }
                            
                            // Cr√©er un marqueur d√©pla√ßable
                            updateDebug('üìå Cr√©ation marqueur d√©pla√ßable...', 'info');
                            searchMarker = L.marker([lat, lng], {
                                draggable: true,
                                title: result.display_name
                            }).addTo(map);
                            currentMarker = searchMarker; // Alias pour compatibilit√©
                            updateDebug('‚úÖ Marqueur cr√©√© et ajout√© √† la carte', 'success');
                            
                            // Ajouter un popup
                            searchMarker.bindPopup(`
                                <b>${result.display_name}</b><br>
                                Lat: ${lat.toFixed(6)}<br>
                                Lng: ${lng.toFixed(6)}<br>
                                <small>Glissez le marqueur pour affiner la position</small>
                            `).openPopup();
                            updateDebug('‚úÖ Popup configur√©', 'success');
                            
                            // √âv√©nement de d√©placement du marqueur
                            searchMarker.on('dragend', function(event) {
                                const position = event.target.getLatLng();
                                updateDebug(`üìç Marqueur d√©plac√©: Lat=${position.lat}, Lng=${position.lng}`, 'info');
                                updateCoordinates(position.lat, position.lng);
                                
                                // Mettre √† jour le popup
                                searchMarker.setPopupContent(`
                                    <b>Position affin√©e</b><br>
                                    Lat: ${position.lat.toFixed(6)}<br>
                                    Lng: ${position.lng.toFixed(6)}
                                `);
                            });
                            updateDebug('‚úÖ √âv√©nement dragend configur√©', 'success');
                            
                            // Mettre √† jour les coordonn√©es dans Java
                            updateDebug('‚òï Appel updateCoordinates()...', 'info');
                            updateCoordinates(lat, lng);
                            
                            updateDebug('‚úÖ ‚úÖ ‚úÖ SUCC√àS COMPLET!', 'success');
                        } else {
                            updateDebug('‚ö†Ô∏è Aucun r√©sultat trouv√©', 'warn');
                        }
                    })
                    .catch(error => {
                        updateDebug(`‚ùå ERREUR fetch: ${error.message}`, 'error');
                        updateDebug(`‚ùå Stack: ${error.stack}`, 'error');
                        console.error('LocationIQ geocoding error:', error);
                    });
                    
                updateDebug('üîö FIN allerAdresse() (attente r√©ponse async)', 'info');
                
            } catch (error) {
                updateDebug(`‚ùå EXCEPTION dans allerAdresse: ${error.message}`, 'error');
                updateDebug(`‚ùå Stack: ${error.stack}`, 'error');
            }
        }
        
        // Fonction pour notifier Java des nouvelles coordonn√©es
        function updateCoordinates(lat, lng) {
            updateDebug('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'info');
            updateDebug('‚òï D√âBUT updateCoordinates()', 'info');
            updateDebug(`üìç Param√®tres: Lat=${lat}, Lng=${lng}`, 'info');
            
            try {
                // V√©rifier l'existence du connecteur Java
                updateDebug(`üîç window.javaConnector existe? ${!!window.javaConnector}`, 'info');
                
                if (window.javaConnector) {
                    updateDebug(`üîç javaConnector.updateCoordinates existe? ${typeof window.javaConnector.updateCoordinates}`, 'info');
                    
                    if (typeof window.javaConnector.updateCoordinates === 'function') {
                        updateDebug(`‚òï Appel javaConnector.updateCoordinates(${lng}, ${lat})...`, 'info');
                        window.javaConnector.updateCoordinates(lng, lat); // longitude, latitude
                        updateDebug('‚úÖ Coordonn√©es envoy√©es √† Java avec succ√®s!', 'success');
                    } else {
                        updateDebug('‚ùå javaConnector.updateCoordinates n\'est pas une fonction!', 'error');
                    }
                } else {
                    updateDebug('‚ùå window.javaConnector n\'existe pas!', 'error');
                    updateDebug('üí° Le pont Java n\'est pas configur√©', 'warn');
                }
            } catch (error) {
                updateDebug(`‚ùå ERREUR updateCoordinates: ${error.message}`, 'error');
                updateDebug(`‚ùå Stack: ${error.stack}`, 'error');
            }
            
            updateDebug('üîö FIN updateCoordinates()', 'info');
        }
        
        function choixZoom(level) {
            setZoom(level);
        }
        
        function getNomsLayers() {
            // Retourne les noms des couches disponibles avec | comme s√©parateur
            // Le * indique la couche active
            if (currentMapType === 'osm') {
                return "*OpenStreetMap|Satellite";
            } else {
                return "OpenStreetMap|*Satellite";
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RADAR (Champ de vision)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let radarLayer = null; // Layer pour le radar (champ de vision)
        
        /**
         * Affiche un radar (champ de vision) sur la carte
         * @param {number} lat - Latitude du centre
         * @param {number} lng - Longitude du centre
         * @param {number} angle - Angle de direction en degr√©s (0 = Nord)
         * @param {number} fov - Ouverture du champ de vision en degr√©s
         * @param {number} radius - Rayon en m√®tres
         * @param {string} strokeColor - Couleur de la bordure (#RRGGBB)
         * @param {string} fillColor - Couleur de remplissage (#RRGGBB)
         * @param {number} opacity - Opacit√© (0-1)
         */
        function afficheRadar(lat, lng, angle, fov, radius, strokeColor, fillColor, opacity) {
            updateDebug(`üì° afficheRadar(${lat}, ${lng}, angle=${angle}¬∞, FOV=${fov}¬∞, radius=${radius}m)`, 'info');
            
            try {
                // Retirer l'ancien radar si existant
                retireRadar();
                
                // Convertir l'angle (0¬∞ = Nord) en radians
                const angleRad = (angle - 90) * Math.PI / 180; // -90 car 0¬∞ = Est en math
                const fovRad = fov * Math.PI / 180;
                
                // Calculer les angles de d√©but et fin de l'arc
                const startAngle = angleRad - fovRad / 2;
                const endAngle = angleRad + fovRad / 2;
                
                // Cr√©er les points de l'arc
                const points = [[lat, lng]]; // Commencer au centre
                
                // Nombre de segments pour l'arc
                const segments = Math.max(20, Math.ceil(fov / 5));
                
                // G√©n√©rer les points de l'arc
                for (let i = 0; i <= segments; i++) {
                    const currentAngle = startAngle + (endAngle - startAngle) * i / segments;
                    
                    // Calculer la distance en degr√©s (approximation simple)
                    const radiusInDegrees = radius / 111320; // ~111320m par degr√© de latitude
                    
                    const pointLat = lat + radiusInDegrees * Math.sin(currentAngle);
                    const pointLng = lng + radiusInDegrees * Math.cos(currentAngle) / Math.cos(lat * Math.PI / 180);
                    
                    points.push([pointLat, pointLng]);
                }
                
                // Fermer le polygone en revenant au centre
                points.push([lat, lng]);
                
                // Cr√©er le polygone Leaflet
                radarLayer = L.polygon(points, {
                    color: strokeColor,
                    fillColor: fillColor,
                    fillOpacity: opacity,
                    weight: 2,
                    interactive: false // Le radar ne doit pas intercepter les clics
                }).addTo(map);
                
                updateDebug(`‚úÖ Radar affich√© avec ${segments} segments`, 'success');
                
            } catch (error) {
                updateDebug(`‚ùå Erreur afficheRadar: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        /**
         * Retire le radar de la carte
         */
        function retireRadar() {
            if (radarLayer) {
                try {
                    map.removeLayer(radarLayer);
                    radarLayer = null;
                    updateDebug('‚úÖ Radar retir√©', 'info');
                } catch (error) {
                    updateDebug(`‚ùå Erreur retireRadar: ${error.message}`, 'error');
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALISATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Initialize when DOM is ready
        updateDebug('[1/2] DOM charg√©, initialisation Leaflet...', 'info');
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateDebug('[2/2] DOMContentLoaded d√©clench√©', 'success');
                initMap();
            });
        } else {
            updateDebug('[2/2] DOM d√©j√† pr√™t', 'success');
            initMap();
        }
    </script>
</body>
</html>
