<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Leaflet - Iframe</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Leaflet JS -->
    <script src="libs/leaflet/leaflet.js"></script>
    
    <script>
        // Variable globale pour la carte
        var map = null;
        var markers = [];
        var currentTileLayer = null;
        
        // Configuration des couches
        const tileLayers = {
            'osm': {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            },
            'satellite': {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '© Esri',
                maxZoom: 19
            }
        };
        
        // Initialiser la carte
        function initMap() {
            if (map) return;
            
            map = L.map('map', {
                preferCanvas: false,
                renderer: L.svg()
            }).setView([48.8566, 2.3522], 13);
            
            // Ajouter la couche OSM par défaut
            currentTileLayer = L.tileLayer(tileLayers.osm.url, {
                attribution: tileLayers.osm.attribution,
                maxZoom: tileLayers.osm.maxZoom
            }).addTo(map);
            
            // Forcer le recalcul de la taille
            setTimeout(() => {
                map.invalidateSize(true);
            }, 100);
            
            console.log('✅ Carte Leaflet initialisée dans iframe');
        }
        
        // Ajouter un marqueur
        function addMarker(lat, lng, title) {
            if (!map) return;
            
            var marker = L.marker([lat, lng]).addTo(map);
            if (title) {
                marker.bindPopup(title);
            }
            markers.push(marker);
            return markers.length - 1;
        }
        
        // Supprimer un marqueur
        function removeMarker(index) {
            if (!map || !markers[index]) return;
            
            map.removeLayer(markers[index]);
            markers[index] = null;
        }
        
        // Supprimer tous les marqueurs
        function removeAllMarkers() {
            if (!map) return;
            
            markers.forEach(marker => {
                if (marker) map.removeLayer(marker);
            });
            markers = [];
        }
        
        // Centrer sur une position
        function centerOn(lat, lng, zoom) {
            if (!map) return;
            
            if (zoom) {
                map.setView([lat, lng], zoom);
            } else {
                map.panTo([lat, lng]);
            }
        }
        
        // Changer le type de carte
        function setMapType(type) {
            if (!map || !tileLayers[type]) return;
            
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            currentTileLayer = L.tileLayer(tileLayers[type].url, {
                attribution: tileLayers[type].attribution,
                maxZoom: tileLayers[type].maxZoom
            }).addTo(map);
        }
        
        // Changer le zoom
        function setZoom(level) {
            if (!map) return;
            map.setZoom(level);
        }
        
        // Obtenir le centre actuel
        function getCenter() {
            if (!map) return null;
            var center = map.getCenter();
            return { lat: center.lat, lng: center.lng };
        }
        
        // Obtenir le zoom actuel
        function getZoom() {
            if (!map) return null;
            return map.getZoom();
        }
        
        // Exposer les fonctions au parent
        window.mapAPI = {
            initMap: initMap,
            addMarker: addMarker,
            removeMarker: removeMarker,
            removeAllMarkers: removeAllMarkers,
            centerOn: centerOn,
            setMapType: setMapType,
            setZoom: setZoom,
            getCenter: getCenter,
            getZoom: getZoom
        };
        
        // Initialiser au chargement
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            initMap();
        }
    </script>
</body>
</html>
