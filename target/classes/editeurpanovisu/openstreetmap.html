<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Carte Interactive - OpenStreetMap LOCAL JavaFX23</title>
    
    <!-- Leaflet CSS depuis fichiers LOCAUX (CDN bloqu√© dans JavaFX WebView) -->
    <link rel="stylesheet" href="libs/leaflet/leaflet.css"/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: relative;
        }
        
        #map {
            position: absolute !important;
            top: 152px !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: calc(100% - 152px) !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #f0f0f0;
        }
        
        /* Contr√¥les de type de carte */
        .map-controls {
            position: absolute;
            top: 162px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .map-controls select {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
        }
        
        /* Personnalisation des popups */
        .leaflet-popup-content {
            margin: 10px;
            min-width: 150px;
        }
        
        .popup-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .popup-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .popup-link {
            display: inline-block;
            padding: 5px 10px;
            background: #0078d4;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 13px;
        }
        
        .popup-link:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <!-- Panneau de diagnostic PERMANENT en haut avec scroll -->
    <div id="debug-panel" style="position:fixed;top:0;left:0;right:0;background:rgba(0,0,0,0.95);color:#0f0;
                                  padding:10px;font-family:monospace;font-size:11px;z-index:99999;
                                  border-bottom:2px solid #0f0;height:150px;
                                  overflow-y:auto;overflow-x:hidden;">
        <div id="debug-content">üîç DEBUG: Page charg√©e - En attente d'initialisation...</div>
    </div>
    
    <div id="map">
        <!-- Indicateur de chargement -->
        <div id="loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                                  background:white;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.3);
                                  font-family:Arial;text-align:center;z-index:9999;">
            <div style="font-size:24px;margin-bottom:10px;">üó∫Ô∏è</div>
            <div style="font-size:16px;color:#333;">Chargement de la carte...</div>
            <div style="font-size:12px;color:#666;margin-top:5px;">OpenStreetMap + Leaflet.js</div>
        </div>
    </div>
    
    <div class="map-controls">
        <select id="mapType">
            <option value="osm">OpenStreetMap Standard</option>
            <option value="satellite">Satellite (Esri)</option>
        </select>
    </div>
    
    <!-- Test imm√©diat avec debug d√©taill√© -->
    <script>
        console.log('üî∑ [1/5] Script de test ex√©cut√© AVANT Leaflet');
        
        // Compteur de messages
        let debugMessages = [];
        
        function updateDebug(msg, color) {
            console.log(msg);
            
            // Ajouter le message √† la liste avec timestamp
            const timestamp = new Date().toLocaleTimeString('fr-FR', {hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3});
            debugMessages.push('[' + timestamp + '] ' + msg);
            
            // Mettre √† jour le panneau de debug (accumuler les messages)
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = debugMessages.join('<br>');
                // Auto-scroll vers le bas
                const panel = document.getElementById('debug-panel');
                if (panel) panel.scrollTop = panel.scrollHeight;
            }
            
            // Mettre √† jour le loading si erreur
            const loading = document.getElementById('loading');
            if (loading && color === 'red') {
                loading.innerHTML = '<div style="font-size:24px;margin-bottom:10px;color:red;">‚ùå</div>' +
                                   '<div style="font-size:16px;color:red;">' + msg + '</div>';
            }
        }
        
        updateDebug('üî∑ [1/5] Page HTML charg√©e, attente DOM...', 'green');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üî∑ [2/5] DOM charg√©, attente Leaflet...');
            updateDebug('üî∑ [2/5] DOM pr√™t, chargement Leaflet.js...', 'yellow');
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = '<div style="font-size:24px;margin-bottom:10px;">‚è≥</div>' +
                                   '<div style="font-size:16px;color:#333;">Chargement de Leaflet.js...</div>' +
                                   '<div style="font-size:12px;color:#666;margin-top:5px;">Patientez...</div>';
            }
        });
    </script>
    
    <!-- Leaflet JavaScript depuis fichiers LOCAUX -->
    <script src="libs/leaflet/leaflet.js" onerror="console.error('‚ùå ERREUR CHARGEMENT leaflet.js'); updateDebug('‚ùå Erreur chargement leaflet.js', 'red');" onload="console.log('‚úÖ leaflet.js charg√© avec succ√®s');"></script>
    
    <script>
        console.log('üî∑ [3/5] Script principal apr√®s Leaflet ex√©cut√©');
        updateDebug('ÔøΩ [3/5] Script principal charg√©, test Leaflet...', 'green');
        
        // Test de disponibilit√© de Leaflet
        if (typeof L === 'undefined') {
            console.error('‚ùå [FATAL] Leaflet n\'est pas charg√© apr√®s <script> !');
            updateDebug('‚ùå ERREUR: Variable L (Leaflet) introuvable apr√®s chargement script', 'red');
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = '<div style="font-size:24px;margin-bottom:10px;color:red;">‚ùå</div>' +
                                   '<div style="font-size:16px;color:red;">ERREUR: Leaflet.js non charg√©</div>' +
                                   '<div style="font-size:12px;color:#666;margin-top:5px;">Variable L introuvable</div>';
            }
        } else {
            console.log('‚úÖ [SUCCESS] Leaflet disponible, version:', L.version);
            updateDebug('‚úÖ [4/5] Leaflet v' + L.version + ' charg√©, initialisation carte...', 'green');
            
            // AUTO-INITIALISATION IMM√âDIATE pour JavaFX
            console.log('üöÄ AUTO-INITIALISATION FORC√âE pour JavaFX 23+');
            updateDebug('üöÄ [5/5] Auto-initialisation de la carte...', 'green');
            
            // V√©rifier si le DOM est d√©j√† charg√©
            if (document.readyState === 'loading') {
                // DOM pas encore charg√©, attendre
                console.log('‚è≥ DOM en cours de chargement, attente...');
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('‚úÖ DOMContentLoaded d√©clench√©');
                    setTimeout(function() {
                        console.log('üöÄ Lancement initialisation carte...');
                        initializeMap();
                    }, 100);
                });
            } else {
                // DOM d√©j√† charg√©, initialiser imm√©diatement
                console.log('‚úÖ DOM d√©j√† charg√©, initialisation imm√©diate');
                setTimeout(function() {
                    console.log('üöÄ Lancement initialisation carte...');
                    initializeMap();
                }, 100);
            }
        }
        
        // Configuration des couches de carte (100% gratuites)
        const tileLayers = {
            'osm': {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            },
            'satellite': {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '¬© <a href="https://www.esri.com/">Esri</a>, Maxar, Earthstar Geographics',
                maxZoom: 19
            }
        };
        
        // Variables globales pour la carte
        let map = null;
        let currentLayer = null;
        let marqueursCompat = {};
        
        console.log('üìã Configuration des tuiles:', tileLayers);
        
        // Gestion du changement de type de carte
        document.getElementById('mapType').addEventListener('change', function(e) {
            if (!map) {
                console.warn('‚ö†Ô∏è Carte non encore initialis√©e');
                return;
            }
            
            const selectedType = e.target.value;
            const layerConfig = tileLayers[selectedType];
            
            // Retirer l'ancienne couche
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            
            // Ajouter la nouvelle couche
            currentLayer = L.tileLayer(layerConfig.url, {
                attribution: layerConfig.attribution,
                maxZoom: layerConfig.maxZoom
            }).addTo(map);
            
            console.log('üó∫Ô∏è Type de carte chang√©:', selectedType);
        });
        
        // Stockage des marqueurs
        const markers = {};
        let markerIdCounter = 0;
        
        // === API JavaScript pour interaction avec Java ===
        
        /**
         * Ajoute un marqueur sur la carte.
         * @param {number} lat - Latitude
         * @param {number} lng - Longitude
         * @param {string} title - Titre du marqueur (tooltip)
         * @param {string} popup - Contenu HTML du popup (optionnel)
         * @param {string} icon - URL de l'ic√¥ne personnalis√©e (optionnel)
         * @returns {number} ID du marqueur
         */
        window.addMarker = function(lat, lng, title, popup, icon) {
            const markerId = markerIdCounter++;
            
            const markerOptions = {
                title: title || ''
            };
            
            // Ic√¥ne personnalis√©e si fournie
            if (icon) {
                markerOptions.icon = L.icon({
                    iconUrl: icon,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });
            }
            
            const marker = L.marker([lat, lng], markerOptions).addTo(map);
            
            // Tooltip (survol)
            if (title) {
                marker.bindTooltip(title, {
                    permanent: false,
                    direction: 'top'
                });
            }
            
            // Popup (clic)
            if (popup) {
                marker.bindPopup(popup);
            }
            
            // Stocker le marqueur
            markers[markerId] = marker;
            
            return markerId;
        };
        
        /**
         * Supprime un marqueur sp√©cifique.
         * @param {number} markerId - ID du marqueur
         */
        window.removeMarker = function(markerId) {
            if (markers[markerId]) {
                map.removeLayer(markers[markerId]);
                delete markers[markerId];
            }
        };
        
        /**
         * Supprime tous les marqueurs.
         */
        window.clearMarkers = function() {
            Object.values(markers).forEach(marker => {
                map.removeLayer(marker);
            });
            markers = {};
            markerIdCounter = 0;
        };
        
        /**
         * Centre la carte sur une position.
         * @param {number} lat - Latitude
         * @param {number} lng - Longitude
         * @param {number} zoom - Niveau de zoom (optionnel, d√©faut: 13)
         */
        window.setCenter = function(lat, lng, zoom) {
            map.setView([lat, lng], zoom || 13);
        };
        
        /**
         * Change le type de carte.
         * @param {string} type - Type de carte ('osm', 'satellite')
         */
        window.setMapType = function(type) {
            if (tileLayers[type]) {
                document.getElementById('mapType').value = type;
                document.getElementById('mapType').dispatchEvent(new Event('change'));
            }
        };
        
        /**
         * Ajuste la vue pour afficher tous les marqueurs.
         */
        window.fitBounds = function() {
            const markerList = Object.values(markers);
            if (markerList.length > 0) {
                const group = L.featureGroup(markerList);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        };
        
        /**
         * Ajoute un cercle sur la carte.
         * @param {number} lat - Latitude
         * @param {number} lng - Longitude
         * @param {number} radius - Rayon en m√®tres
         * @param {string} color - Couleur (d√©faut: blue)
         */
        window.addCircle = function(lat, lng, radius, color) {
            return L.circle([lat, lng], {
                color: color || 'blue',
                fillColor: color || 'blue',
                fillOpacity: 0.2,
                radius: radius
            }).addTo(map);
        };
        
        /**
         * Ajoute une polyligne (chemin).
         * @param {Array} points - Tableau de [lat, lng]
         * @param {string} color - Couleur (d√©faut: red)
         * @param {number} weight - √âpaisseur (d√©faut: 3)
         */
        window.addPolyline = function(points, color, weight) {
            return L.polyline(points, {
                color: color || 'red',
                weight: weight || 3
            }).addTo(map);
        };
        
        /**
         * Obtient le centre actuel de la carte.
         * @returns {Object} {lat, lng, zoom}
         */
        window.getCenter = function() {
            const center = map.getCenter();
            return {
                lat: center.lat,
                lng: center.lng,
                zoom: map.getZoom()
            };
        };
        
        /**
         * Active/d√©sactive l'interaction utilisateur.
         * @param {boolean} enabled - true pour activer, false pour d√©sactiver
         */
        window.setInteractive = function(enabled) {
            if (enabled) {
                map.dragging.enable();
                map.touchZoom.enable();
                map.doubleClickZoom.enable();
                map.scrollWheelZoom.enable();
                map.boxZoom.enable();
                map.keyboard.enable();
            } else {
                map.dragging.disable();
                map.touchZoom.disable();
                map.doubleClickZoom.disable();
                map.scrollWheelZoom.disable();
                map.boxZoom.disable();
                map.keyboard.disable();
            }
        };
        
        // === Events vers Java ===
        
        // Clic sur la carte
        map.on('click', function(e) {
            if (window.javaConnector && window.javaConnector.onMapClick) {
                window.javaConnector.onMapClick(e.latlng.lat, e.latlng.lng);
            }
        });
        
        // Clic sur un marqueur
        Object.values(markers).forEach(marker => {
            marker.on('click', function(e) {
                if (window.javaConnector && window.javaConnector.onMarkerClick) {
                    window.javaConnector.onMarkerClick(
                        e.latlng.lat, 
                        e.latlng.lng,
                        markers.indexOf(marker)
                    );
                }
            });
        });
        
        // Changement de vue (zoom/pan)
        map.on('moveend', function() {
            if (window.javaConnector && window.javaConnector.onViewChanged) {
                const center = map.getCenter();
                window.javaConnector.onViewChanged(
                    center.lat, 
                    center.lng, 
                    map.getZoom()
                );
            }
        });
        
        // ========== Initialisation de la carte ==========
        
        // Timeout de s√©curit√© si Leaflet ne charge pas
        setTimeout(function() {
            if (typeof L === 'undefined') {
                console.error('‚è±Ô∏è TIMEOUT: Leaflet n\'a pas charg√© apr√®s 5 secondes');
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.innerHTML = '<div style="font-size:24px;margin-bottom:10px;color:orange;">‚ö†Ô∏è</div>' +
                                       '<div style="font-size:16px;color:orange;">Timeout: Leaflet.js ne r√©pond pas</div>' +
                                       '<div style="font-size:12px;color:#666;margin-top:5px;">La connexion internet est peut-√™tre trop lente</div>' +
                                       '<div style="font-size:12px;color:#666;margin-top:5px;">ou bloqu√©e par le pare-feu</div>';
                }
            }
        }, 5000);
        
        // Fonction d'initialisation de la carte
        function initializeMap() {
            console.log('üîß D√©marrage initialisation carte...');
            const timestamp = new Date().toISOString();
            document.title = 'Init: ' + timestamp;
            
            // Mettre √† jour le panneau de debug
            const debugPanel = document.getElementById('debug-panel');
            if (debugPanel) {
                debugPanel.innerHTML = 'üîç DEBUG: initializeMap() appel√©e √† ' + timestamp;
                debugPanel.style.background = 'rgba(0,0,255,0.9)';
            }
            
            // GARDE: Emp√™cher la double initialisation
            if (map !== null) {
                console.warn('‚ö†Ô∏è CARTE D√âJ√Ä INITIALIS√âE ! Ignorant l\'appel.');
                if (debugPanel) {
                    debugPanel.innerHTML = '‚ö†Ô∏è ERREUR: DOUBLE INITIALISATION D√âTECT√âE √† ' + timestamp;
                    debugPanel.style.background = 'rgba(255,0,0,0.9)';
                    debugPanel.style.color = '#fff';
                }
                alert('‚ö†Ô∏è DOUBLE INITIALISATION D√âTECT√âE!\nTimestamp: ' + timestamp + '\nCette alerte ne devrait JAMAIS appara√Ætre.');
                return;
            }
            
            console.log('‚úÖ Premi√®re initialisation OK - Timestamp: ' + timestamp);
            if (debugPanel) {
                debugPanel.innerHTML = '‚úÖ DEBUG: Premi√®re initialisation OK √† ' + timestamp;
                debugPanel.style.background = 'rgba(0,128,0,0.9)';
            }
            
            // V√©rifier que l'√©l√©ment map existe
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('‚ùå √âl√©ment #map introuvable !');
                // R√©essayer apr√®s un d√©lai
                setTimeout(initializeMap, 100);
                return;
            }
            
            // V√©rifier que l'√©l√©ment a une taille valide
            const rect = mapElement.getBoundingClientRect();
            console.log('üìè Dimensions du conteneur:', rect.width, 'x', rect.height);
            
            if (rect.width === 0 || rect.height === 0) {
                console.warn('‚ö†Ô∏è Conteneur sans dimensions valides, nouvelle tentative dans 200ms...');
                setTimeout(initializeMap, 200);
                return;
            }
            
            console.log('‚úÖ √âl√©ment #map trouv√© avec dimensions valides:', rect.width, 'x', rect.height);
            
            // V√©rifier Leaflet
            if (typeof L === 'undefined') {
                console.error('‚ùå Leaflet non disponible au moment de l\'initialisation');
                mapElement.innerHTML = '<div style="padding:20px;color:red;background:white;">ERREUR: Leaflet.js non disponible</div>';
                return;
            }
            
            try {
                console.log('üó∫Ô∏è Cr√©ation de la carte UNIQUE avec dimensions:', rect.width, 'x', rect.height);
                
                if (debugPanel) {
                    debugPanel.innerHTML = 'üó∫Ô∏è Cr√©ation carte ' + rect.width + 'x' + rect.height + 'px...';
                }
                
                // Cr√©er la carte avec options optimis√©es pour JavaFX WebView
                // Note: preferCanvas:false car JavaFX WebView a des bugs de rendu avec Canvas
                map = L.map('map', {
                    center: [48.8566, 2.3522],
                    zoom: 13,
                    zoomControl: true,
                    preferCanvas: false,  // IMPORTANT: false pour JavaFX WebView (SVG au lieu de Canvas)
                    fadeAnimation: false,  // D√©sactiver animations qui peuvent causer des probl√®mes
                    zoomAnimation: false,
                    markerZoomAnimation: false,
                    renderer: L.svg()  // Forcer le rendu SVG au lieu de Canvas
                });
                
                console.log('‚úÖ Objet carte cr√©√©:', map);
                
                if (debugPanel) {
                    debugPanel.innerHTML = '‚úÖ Carte cr√©√©e - Ajout des tuiles...';
                }
                
                // Couche de carte par d√©faut (OSM)
                console.log('üåç Ajout de la couche OSM...');
                currentLayer = L.tileLayer(tileLayers['osm'].url, {
                    attribution: tileLayers['osm'].attribution,
                    maxZoom: tileLayers['osm'].maxZoom,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='
                });
                
                currentLayer.on('tileload', function() {
                    console.log('üì• Tuile charg√©e');
                });
                
                currentLayer.on('tileerror', function(error) {
                    console.error('‚ùå Erreur chargement tuile:', error);
                });
                
                currentLayer.addTo(map);
                console.log('‚úÖ Couche ajout√©e √† la carte');
                
                // Diagnostic des dimensions de la carte
                const container = map.getContainer();
                const size = map.getSize();
                console.log('üìä Diagnostic carte:');
                console.log('   - Container size:', container.offsetWidth, 'x', container.offsetHeight);
                console.log('   - Map size:', size.x, 'x', size.y);
                console.log('   - Map bounds:', map.getBounds());
                console.log('   - Pixel bounds:', map.getPixelBounds());
                
                if (debugPanel) {
                    debugPanel.innerHTML = '‚úÖ Carte initialis√©e | Container: ' + container.offsetWidth + 'x' + container.offsetHeight + 
                                          ' | Map: ' + size.x + 'x' + size.y + ' | Zoom: ' + map.getZoom();
                    debugPanel.style.background = 'rgba(0,255,0,0.9)';
                    debugPanel.style.color = '#000';
                }
                
                // Masquer le loading div
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                
                // Forcer le recalcul multiple fois pour √©viter les probl√®mes de dimensionnement
                console.log('üîÑ Invalidation de la taille de la carte...');
                
                // Invalidation imm√©diate avec force = true
                map.invalidateSize(true);
                
                // Invalidations progressives avec force = true
                setTimeout(() => {
                    map.invalidateSize(true);
                    map.panBy([1, 0]); // Micro-d√©placement pour forcer le rendu
                    map.panBy([-1, 0]);
                    console.log('‚úÖ Carte redimensionn√©e forc√©e (100ms)');
                }, 100);
                
                setTimeout(() => {
                    map.invalidateSize(true);
                    console.log('‚úÖ Carte redimensionn√©e forc√©e (300ms)');
                }, 300);
                
                setTimeout(() => {
                    map.invalidateSize(true);
                    console.log('‚úÖ Carte redimensionn√©e forc√©e (500ms)');
                }, 500);
                
                setTimeout(() => {
                    map.invalidateSize(true);
                    // Recentrer pour s'assurer que tout est visible
                    map.setView(map.getCenter(), map.getZoom(), {animate: false});
                    console.log('‚úÖ Carte Leaflet initialis√©e et dimensionn√©e (1000ms)');
                    console.log('   Centre:', map.getCenter());
                    console.log('   Zoom:', map.getZoom());
                    console.log('   Container size:', map.getContainer().offsetWidth, 'x', map.getContainer().offsetHeight);
                    console.log('   Map size:', map.getSize());
                }, 1000);
                
                // Notifier Java que la carte est pr√™te
                if (window.javaConnector && window.javaConnector.mapReady) {
                    window.javaConnector.mapReady();
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation de la carte:', error);
                console.error('   Stack:', error.stack);
                mapElement.innerHTML = '<div style="padding:20px;color:red;background:white;">ERREUR: ' + error.message + '</div>';
            }
        }
        
        // ‚ö†Ô∏è IMPORTANT: L'initialisation est g√©r√©e par Java via Platform.runLater
        // Ne PAS appeler initializeMap() ici pour √©viter la double initialisation !
        
        // D√âSACTIV√â - causait une double initialisation avec superposition de cartes:
        // setTimeout(initializeMap, 100);
        // document.addEventListener('DOMContentLoaded', initializeMap);
        // window.addEventListener('load', initializeMap);
        
        console.log('‚è≥ En attente de l\'appel initializeMap() depuis Java...');
        
        // G√©rer le redimensionnement
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        });
        
        // ========== Compatibilit√© avec l'ancienne API OpenLayers ==========
        // Ces fonctions maintiennent la compatibilit√© avec le code Java existant
        
        /**
         * Convertit longitude en mercator (compatibilit√© OpenLayers)
         */
        function longitude2Mercator(lon) {
            return lon;  // Leaflet utilise directement WGS84
        }
        
        /**
         * Convertit latitude en mercator (compatibilit√© OpenLayers)
         */
        function latitude2Mercator(lat) {
            return lat;  // Leaflet utilise directement WGS84
        }
        
        /**
         * Convertit mercator en longitude (compatibilit√© OpenLayers)
         */
        function mercator2Longitude(lon) {
            return lon;  // Leaflet utilise directement WGS84
        }
        
        /**
         * Convertit mercator en latitude (compatibilit√© OpenLayers)
         */
        function mercator2Latitude(lat) {
            return lat;  // Leaflet utilise directement WGS84
        }
        
        /**
         * Va aux coordonn√©es sp√©cifi√©es (compatibilit√© OpenLayers)
         */
        function allerCoordonnees(longitude, latitude, zoom) {
            if (!map) {
                console.warn('‚ö†Ô∏è Carte non initialis√©e pour allerCoordonnees');
                return;
            }
            map.setView([latitude, longitude], zoom || 13);
            setTimeout(() => map.invalidateSize(), 100);
        }
        
        /**
         * Change le zoom (compatibilit√© OpenLayers)
         */
        function choixZoom(zoom) {
            if (!map) {
                console.warn('‚ö†Ô∏è Carte non initialis√©e pour choixZoom');
                return;
            }
            map.setZoom(zoom);
        }
        
        /**
         * Obtient les coordonn√©es du centre de la carte (compatibilit√© OpenLayers)
         */
        function getCoordonnees() {
            if (!map) {
                console.warn('‚ö†Ô∏è Carte non initialis√©e pour getCoordonnees');
                return "0;0";
            }
            const center = map.getCenter();
            return center.lng.toFixed(6) + ";" + center.lat.toFixed(6);
        }
        
        /**
         * Ajoute un marqueur (compatibilit√© OpenLayers)
         */
        function ajouteMarqueur(numeroMarqueur, longitude, latitude, contenuPopup) {
            if (!map) {
                console.warn('‚ö†Ô∏è Carte non initialis√©e pour ajouteMarqueur');
                return;
            }
            
            const marker = L.marker([latitude, longitude]).addTo(map);
            
            if (contenuPopup) {
                marker.bindPopup(contenuPopup);
            }
            
            marqueursCompat[numeroMarqueur] = marker;
        }
        
        /**
         * Enl√®ve un marqueur (compatibilit√© OpenLayers)
         */
        function enleveMarqueur(numeroMarqueur) {
            if (!map) {
                console.warn('‚ö†Ô∏è Carte non initialis√©e pour enleveMarqueur');
                return;
            }
            if (marqueursCompat[numeroMarqueur]) {
                map.removeLayer(marqueursCompat[numeroMarqueur]);
                delete marqueursCompat[numeroMarqueur];
            }
        }
        
        /**
         * Enl√®ve tous les marqueurs (compatibilit√© OpenLayers)
         */
        function enleveMarqueurs() {
            if (!map) {
                console.warn('‚ö†Ô∏è Carte non initialis√©e pour enleveMarqueurs');
                return;
            }
            for (let id in marqueursCompat) {
                map.removeLayer(marqueursCompat[id]);
            }
            marqueursCompat = {};
        }
        
        /**
         * Obtient la liste des couches de carte (compatibilit√© OpenLayers)
         */
        function getNomsLayers() {
            const currentType = document.getElementById('mapType').value;
            let result = "";
            for (let type in tileLayers) {
                if (type === currentType) {
                    result += "*" + type + "|";
                } else {
                    result += type + "|";
                }
            }
            return result;
        }
        
        /**
         * Change la couche de carte (compatibilit√© OpenLayers)
         */
        function changeLayer(strLayer) {
            window.setMapType(strLayer);
        }
        
        /**
         * Recherche une adresse (compatibilit√© OpenLayers - fonction vide pour l'instant)
         */
        function chercheAdresse(adresse, zoom) {
            console.log("Recherche d'adresse non impl√©ment√©e dans Leaflet:", adresse);
            // TODO: Impl√©menter avec Nominatim si n√©cessaire
        }
        
        /**
         * Configure Bing API Key (compatibilit√© OpenLayers - non utilis√© avec Esri)
         */
        function setBingApiKey(key) {
            console.log("setBingApiKey appel√© mais non utilis√© (Esri n'en a pas besoin)");
        }
        
        /**
         * Affiche le radar (compatibilit√© OpenLayers)
         */
        function afficheRadar(centreX, centreY, rayon, angle, angle2, opacite) {
            console.log("afficheRadar non impl√©ment√©:", arguments);
            // TODO: Impl√©menter si n√©cessaire avec L.circle ou L.sector
        }
        
        /**
         * Retire le radar (compatibilit√© OpenLayers)
         */
        function retireRadar() {
            console.log("retireRadar appel√©");
        }
        
        console.log("‚úÖ API de compatibilit√© OpenLayers charg√©e");
    </script>
</body>
</html>
