# üìù CHANGELOG - Syst√®me IA

## Build 2584 (14 octobre 2025)

### üîÑ Migration DeepSeek-R1 : 70B ‚Üí 32B

#### Modifications
- **OllamaService.java ligne 260** : DeepSeek-R1 remont√© en priorit√© 2 (apr√®s mistral-nemo)
  ```java
  String[] modelesPreferences = {
      "mistral-nemo", // 7 GB - Priority 1
      "deepseek-r1",  // ~20 GB (32B) - Priority 2 ‚Üê MODIFI√â
      "qwen2.5",      // 4.7 GB - Priority 3
      // ...
  };
  ```

- **OllamaService.java ligne 1167** : Message d'erreur HTTP 500 g√©n√©ralis√©
  ```java
  // AVANT
  errorMsg += " (m√©moire insuffisante? Mod√®le trop lourd: 42 GB)";
  
  // APR√àS
  errorMsg += " (m√©moire insuffisante? Essayez un mod√®le plus l√©ger)";
  ```

- **OllamaService.java ligne 257** : Commentaire mis √† jour
  ```java
  // AVANT
  // DeepSeek-R1 70B d√©sactiv√© : trop lourd (42 GB), cause HTTP 500
  
  // APR√àS
  // DeepSeek-R1 32B : plus l√©ger que le 70B (~20 GB vs 42 GB)
  ```

#### Raison
- Le mod√®le 70B (42 GB) causait des erreurs **HTTP 500** par manque de m√©moire
- La version 32B (~20 GB) est plus stable tout en conservant 90% des capacit√©s

#### Impact
- ‚úÖ Utilisateurs avec 24-32 GB RAM peuvent maintenant utiliser DeepSeek-R1
- ‚úÖ Performances am√©lior√©es (g√©n√©ration plus rapide)
- ‚úÖ Pas de changement pour les autres mod√®les

---

## Build 2583 (14 octobre 2025)

### ‚ùå D√©sactivation Hugging Face

#### Modifications
- **OllamaService.java ligne 1010-1044** : Hugging Face d√©sactiv√©, messages d'erreur contextuels
  ```java
  // AVANT
  try {
      return appellerOllamaLocal(prompt);
  } catch (Exception e) {
      System.out.println("[IA] ‚û§ Fallback vers Hugging Face...");
  }
  return appellerHuggingFace(prompt);
  
  // APR√àS
  try {
      return appellerOllamaLocal(prompt);
  } catch (Exception e) {
      String messageErreur = "‚ùå Aucun service IA disponible !\n\n";
      // ... messages contextuels selon le mode ...
      throw new Exception(messageErreur);
  }
  throw new Exception("‚ùå Mode Hugging Face d√©sactiv√©.");
  ```

#### Raison
- Mod√®les Hugging Face obsol√®tes (erreurs **HTTP 404**)
- Pas de maintenance depuis plusieurs mois
- Sources de confusion pour les utilisateurs

#### Impact
- ‚úÖ Messages d'erreur plus clairs et exploitables
- ‚úÖ Pas de tentative inutile vers un service cass√©
- ‚ö†Ô∏è Les utilisateurs sans OpenRouter ni Ollama re√ßoivent un message les guidant

### üîß Am√©lioration gestion d'erreur

#### Modifications
- **OllamaService.java ligne 1163-1171** : Message HTTP 500 d√©taill√© pour Ollama
  ```java
  if (responseCode == 500) {
      errorMsg += " (m√©moire insuffisante? Mod√®le trop lourd: 42 GB)";
  }
  ```

#### Impact
- ‚úÖ Utilisateurs comprennent pourquoi DeepSeek-R1 70B √©choue
- ‚úÖ Incitation √† utiliser des mod√®les plus l√©gers

### üìâ DeepSeek-R1 70B d√©prioris√©

#### Modifications
- **OllamaService.java ligne 257-268** : DeepSeek-R1 mis en **derni√®re position**
  ```java
  String[] modelesPreferences = {
      "mistral-nemo", // Priority 0
      "qwen2.5",      // Priority 1
      "llama3.1",     // Priority 2
      "gemma2",       // Priority 3
      // ...
      "deepseek-r1"   // Priority 8 (DERNIER) ‚Üê MODIFI√â
  };
  ```

#### Raison
- Le mod√®le 70B (42 GB) cause trop d'erreurs HTTP 500
- Priorit√© donn√©e aux mod√®les l√©gers et stables

#### Impact
- ‚úÖ Les utilisateurs avec DeepSeek-R1 install√© l'utiliseront en dernier recours
- ‚úÖ Favorise mistral-nemo, qwen2.5, llama3.1 (plus stables)

---

## Build 2582 (14 octobre 2025)

### üîÑ Toggle Online/Offline

#### Modifications
- **EditeurPanovisu.java ligne 92** : Import ToggleButton
  ```java
  import javafx.scene.control.ToggleButton;
  ```

- **EditeurPanovisu.java ligne 11116-11176** : Ajout du ToggleButton dans l'interface
  ```java
  ToggleButton toggleModeIA = new ToggleButton();
  toggleModeIA.setLayoutX(240);
  toggleModeIA.setLayoutY(218);
  toggleModeIA.setPrefSize(90, 30);
  
  // Initial state
  boolean openRouterDispo = OllamaService.verifierOpenRouterDisponible();
  toggleModeIA.setSelected(!openRouterDispo);
  
  // Toggle listener
  toggleModeIA.selectedProperty().addListener((obs, oldVal, newVal) -> {
      if (newVal) {
          toggleModeIA.setText("üî∏ Offline");
          toggleModeIA.setStyle("-fx-background-color: #4A90E2; -fx-text-fill: white;");
          OllamaService.setForceOllama(true);
      } else {
          toggleModeIA.setText("üåê Online");
          toggleModeIA.setStyle("-fx-background-color: #2ECC71; -fx-text-fill: white;");
          OllamaService.setForceOllama(false);
      }
  });
  ```

- **OllamaService.java ligne 76-78** : Variable forceOllama
  ```java
  private static boolean forceOllama = false;
  ```

- **OllamaService.java ligne 407-418** : M√©thodes setForceOllama() / isForceOllama()
  ```java
  public static void setForceOllama(boolean force) {
      forceOllama = force;
      System.out.println("[IA] Mode forc√©: " + (force ? "Ollama (offline)" : "Priorit√© normale"));
  }
  
  public static boolean isForceOllama() {
      return forceOllama;
  }
  ```

- **OllamaService.java ligne 145-152** : M√©thode verifierOpenRouterDisponible()
  ```java
  public static boolean verifierOpenRouterDisponible() {
      return OPENROUTER_TOKEN != null && !OPENROUTER_TOKEN.isEmpty();
  }
  ```

#### Impact
- ‚úÖ Bascule instantan√©e entre OpenRouter et Ollama
- ‚úÖ Interface visuelle claire (üåê Online vert / üî∏ Offline bleu)
- ‚úÖ √âtat par d√©faut intelligent (Offline si pas de cl√© OpenRouter)

### üÜï DeepSeek-R1 70B ajout√©

#### Modifications
- **OllamaService.java ligne 260** : Ajout √† la liste de priorit√©
  ```java
  String[] modelesPreferences = {
      "deepseek-r1",  // Priority 0 (AJOUT√â)
      "mistral-nemo", // Priority 1
      // ...
  };
  ```

- **ConfigDialogController.java ligne 418-444** : Mapping emoji
  ```java
  else if (modelName.contains("deepseek-r1")) {
      return "üî∏ DeepSeek-R1";
  }
  ```

- **ConfigDialogController.java ligne 460-503** : Mapping inverse
  ```java
  else if (displayName.contains("DeepSeek-R1")) {
      if (displayName.contains(":")) {
          return displayName.replaceFirst("^[^a-z]+\\s*", "").split("\\s+")[0];
      }
      return "deepseek-r1:70b";
  }
  ```

#### Impact
- ‚úÖ Support du mod√®le de raisonnement avanc√© DeepSeek-R1
- ‚ö†Ô∏è Priorit√© 0 trop √©lev√©e (cause des erreurs HTTP 500)
- ‚ö†Ô∏è Sera d√©prioris√© dans Build 2583, puis remplac√© par 32B dans Build 2584

---

## Build 2579 (13 octobre 2025)

### ‚ùå GPT-5 retir√© de la liste

#### Modifications
- **OllamaService.java ligne 34-54** : Suppression de GPT-5
  ```java
  // AVANT (9 mod√®les)
  private static final String[] OPENROUTER_MODELS = {
      "anthropic/claude-sonnet-4.5",
      "anthropic/claude-3-opus",
      "anthropic/claude-3.5-sonnet:20241022",
      "mistralai/mistral-nemo",
      "openai/gpt-5",                     // ‚Üê RETIR√â
      "openai/gpt-oss-120b",
      "openai/gpt-4-turbo",
      "google/gemini-pro",
      "meta-llama/llama-3.1-8b-instruct"
  };
  
  // APR√àS (8 mod√®les)
  private static final String[] OPENROUTER_MODELS = {
      "anthropic/claude-sonnet-4.5",
      "anthropic/claude-3-opus",
      "anthropic/claude-3.5-sonnet:20241022",
      "mistralai/mistral-nemo",
      "openai/gpt-oss-120b",
      "openai/gpt-4-turbo",
      "google/gemini-pro",
      "meta-llama/llama-3.1-8b-instruct"
  };
  ```

- **ConfigDialogController.java** : Suppression des mappings GPT-5

#### Raison
- **Instabilit√© critique** : `finish_reason: length` al√©atoire
- G√©n√©ration vide malgr√© facturation
- "Un coup √ßa marche, un coup √ßa marche pas"

#### Impact
- ‚úÖ Plus d'erreurs impr√©visibles avec GPT-5
- ‚úÖ √âconomies sur l'API (pas de facturation pour g√©n√©rations vides)
- ‚ö†Ô∏è Utilisateurs ayant configur√© GPT-5 rebascul√©s sur Claude Sonnet 4.5

### ‚¨ÜÔ∏è max_tokens augment√©

#### Modifications
- **OllamaService.java ligne 1024** : max_tokens 500 ‚Üí 1500
  ```java
  // AVANT
  String jsonRequest = String.format(
      "{\"model\":\"%s\",\"messages\":[{\"role\":\"user\",\"content\":\"%s\"}],\"max_tokens\":500,\"temperature\":0.3}",
      openrouterModel,
      prompt.replace("\"", "\\\"").replace("\n", "\\n").replace("\r", "")
  );
  
  // APR√àS
  String jsonRequest = String.format(
      "{\"model\":\"%s\",\"messages\":[{\"role\":\"user\",\"content\":\"%s\"}],\"max_tokens\":1500,\"temperature\":0.3}",
      openrouterModel,
      prompt.replace("\"", "\\\"").replace("\n", "\\n").replace("\r", "")
  );
  ```

#### Raison
- GPT-5 tronquait les descriptions avec 500 tokens
- `finish_reason: length` indique que la g√©n√©ration a √©t√© coup√©e

#### Impact
- ‚úÖ Descriptions compl√®tes et d√©taill√©es
- ‚úÖ Plus de troncatures en milieu de phrase
- ‚ö†Ô∏è Co√ªt API l√©g√®rement augment√© (mais descriptions compl√®tes)

### üîß getServiceName() fix√©

#### Modifications
- **OllamaService.java ligne 420-442** : D√©tection du service r√©el utilis√©
  ```java
  // AVANT
  public static String getServiceName() {
      return useHuggingFace ? "Hugging Face (en ligne)" : "Ollama (local)";
  }
  
  // APR√àS
  public static String getServiceName() {
      if (forceOllama) {
          return "Ollama (" + ollamaModel + ")";
      }
      if (OPENROUTER_TOKEN != null && !OPENROUTER_TOKEN.isEmpty()) {
          String modelShort = openrouterModel;
          if (modelShort.contains("/")) {
              modelShort = modelShort.substring(modelShort.lastIndexOf("/") + 1);
          }
          return "OpenRouter (" + modelShort + ")";
      }
      return useHuggingFace ? "Hugging Face (en ligne)" : "Ollama (local)";
  }
  ```

#### Impact
- ‚úÖ Panneau de description affiche le vrai service : "OpenRouter (claude-sonnet-4.5)" ou "Ollama (mistral-nemo)"
- ‚úÖ Plus de confusion entre services

---

## Build 2575 (13 octobre 2025)

### üé® Syst√®me d'√©mojis pour identification visuelle

#### Modifications
- **ConfigDialogController.java ligne 418-444** : Fonction ajouterEmojiModele()
  ```java
  private static String ajouterEmojiModele(String modelName) {
      // OpenRouter
      if (modelName.equals("anthropic/claude-sonnet-4.5")) {
          return "‚≠ê Claude Sonnet 4.5 (Anthropic)";
      } else if (modelName.equals("anthropic/claude-3-opus")) {
          return "üî∑ Claude 3 Opus (Anthropic)";
      }
      // ... etc
      
      // Ollama
      else if (modelName.equals("mistral-nemo")) {
          return "üî∏ Mistral Nemo";
      }
      // ... etc
  }
  ```

- **ConfigDialogController.java ligne 460-503** : Fonction extraireNomModele() (mapping inverse)

#### L√©gende des √©mojis
- ‚≠ê **Default** : Mod√®le par d√©faut (Claude Sonnet 4.5)
- üî∑ **Powerful** : Le plus puissant (Claude 3 Opus)
- üìÖ **Dated** : Version dat√©e sp√©cifique (Claude 3.5 Sonnet 22 oct)
- üá´üá∑ **French** : Fran√ßais natif (Mistral Nemo)
- üí∞ **Economical** : √âconomique (GPT-OSS-120B)
- üåç **Geography** : Expert g√©ographie (GPT-4 Turbo)
- üÜì **Free** : Gratuit (Gemini Pro, Llama 3.1)
- üî∏ **Local** : Ollama local (tous les mod√®les locaux)

#### Impact
- ‚úÖ Identification rapide des mod√®les dans les ComboBox
- ‚úÖ Cat√©gorisation visuelle (cloud vs local, premium vs gratuit, etc.)
- ‚úÖ Meilleure UX pour la s√©lection

### üìà Expansion de la liste : 4 ‚Üí 9 mod√®les OpenRouter

#### Modifications
- **OllamaService.java ligne 34** : OPENROUTER_MODELS √©tendu
  ```java
  // AVANT (4 mod√®les)
  private static final String[] OPENROUTER_MODELS = {
      "anthropic/claude-sonnet-4.5",
      "anthropic/claude-3-opus",
      "mistralai/mistral-nemo",
      "openai/gpt-4-turbo"
  };
  
  // APR√àS (9 mod√®les - GPT-5 sera retir√© en 2579)
  private static final String[] OPENROUTER_MODELS = {
      "anthropic/claude-sonnet-4.5",
      "anthropic/claude-3-opus",
      "anthropic/claude-3.5-sonnet:20241022",
      "mistralai/mistral-nemo",
      "openai/gpt-5",                     // Sera retir√© en 2579
      "openai/gpt-oss-120b",
      "openai/gpt-4-turbo",
      "google/gemini-pro",
      "meta-llama/llama-3.1-8b-instruct"
  };
  ```

#### Nouveaux mod√®les ajout√©s
- **Claude 3.5 Sonnet** (version dat√©e 22 oct 2024)
- **GPT-5** (retir√© en 2579 pour instabilit√©)
- **GPT-OSS-120B** (open source, √©conomique)
- **Gemini Pro** (gratuit)
- **Llama 3.1 8B** (gratuit, open source)

#### Impact
- ‚úÖ Plus de choix selon le besoin (qualit√©, co√ªt, langue)
- ‚úÖ Options gratuites disponibles (Gemini, Llama)
- ‚ö†Ô∏è GPT-5 instable (sera retir√©)

---

## Build 2570 (12 octobre 2025)

### üéõÔ∏è Interface de configuration des mod√®les

#### Modifications
- **EditeurPanovisu.java** : Ajout menu "Fichier > Configuration"
- **ConfigDialogController.java** : Cr√©ation du contr√¥leur de configuration
  - ComboBox pour s√©lection OpenRouter (4 mod√®les)
  - ComboBox pour s√©lection Ollama (d√©tection automatique)
  - TextField pour cl√© API OpenRouter
  - Boutons OK/Annuler avec sauvegarde

#### Fonctionnalit√©s
- ‚úÖ S√©lection visuelle des mod√®les via ComboBox
- ‚úÖ D√©tection automatique des mod√®les Ollama install√©s
- ‚úÖ Sauvegarde des pr√©f√©rences dans `preferences.cfg`
- ‚úÖ Chargement automatique des pr√©f√©rences au d√©marrage

#### Mod√®les disponibles (initiaux)
**OpenRouter (4)** :
- ‚≠ê Claude Sonnet 4.5 (d√©faut)
- üî∑ Claude 3 Opus
- üá´üá∑ Mistral Nemo
- üåç GPT-4 Turbo

**Ollama (d√©tection dynamique)** :
- Tous les mod√®les install√©s localement

#### Impact
- ‚úÖ Configuration intuitive sans √©diter de fichiers
- ‚úÖ Persistance des choix entre sessions
- ‚úÖ Base pour futures am√©liorations (√©mojis, toggle)

### üíæ Syst√®me de persistance

#### Fichiers cr√©√©s
- **`api-keys.properties`** : Cl√© API OpenRouter (jamais commit√©)
- **`preferences.cfg`** : Mod√®les s√©lectionn√©s
  ```
  modele_openrouter=anthropic/claude-sonnet-4.5
  modele_ollama=mistral-nemo
  ```

#### S√©curit√©
- ‚úÖ `api-keys.properties` dans `.gitignore`
- ‚úÖ Template fourni : `api-keys.properties.template`

---

## üìä Statistiques globales

### √âvolution du nombre de mod√®les

| Build | OpenRouter | Ollama | Total |
|-------|------------|--------|-------|
| 2570  | 4          | Auto   | 4+    |
| 2575  | 9          | Auto   | 9+    |
| 2579  | **8**      | Auto   | 8+    |
| 2582  | 8          | Auto + DeepSeek | 8+    |
| 2583  | 8          | Auto   | 8+    |
| 2584  | 8          | Auto   | 8+    |

### Mod√®les OpenRouter finaux (Build 2584)

| Emoji | Mod√®le | Type |
|-------|--------|------|
| ‚≠ê | Claude Sonnet 4.5 | D√©faut |
| üî∑ | Claude 3 Opus | Premium |
| üìÖ | Claude 3.5 Sonnet | Dat√© |
| üá´üá∑ | Mistral Nemo | Fran√ßais |
| üí∞ | GPT-OSS-120B | √âconomique |
| üåç | GPT-4 Turbo | G√©ographie |
| üÜì | Gemini Pro | Gratuit |
| üÜì | Llama 3.1 8B | Gratuit |

### Mod√®les Ollama prioritaires (Build 2584)

| Priorit√© | Mod√®le | Taille | RAM min |
|----------|--------|--------|---------|
| 1Ô∏è‚É£ | mistral-nemo | 7 GB | 8 GB |
| 2Ô∏è‚É£ | deepseek-r1:32b | ~20 GB | 24 GB |
| 3Ô∏è‚É£ | qwen2.5 | 4.7 GB | 8 GB |
| 4Ô∏è‚É£ | llama3.1 | 4.9 GB | 8 GB |
| 5Ô∏è‚É£ | gemma2 | 5.4 GB | 8 GB |

---

## üîÆ Prochaines √©tapes possibles

### Court terme
- [ ] Support d'autres tags DeepSeek (distill, Q8, etc.)
- [ ] Configuration du timeout via l'interface
- [ ] Indicateur de progression pour g√©n√©ration longue
- [ ] Cache des descriptions pour √©viter r√©g√©n√©ration

### Moyen terme
- [ ] Support de mod√®les custom Ollama
- [ ] Fine-tuning des prompts par type de lieu
- [ ] G√©n√©ration multilingue avec d√©tection auto
- [ ] Historique des descriptions g√©n√©r√©es

### Long terme
- [ ] Support de LM Studio et autres backends
- [ ] G√©n√©ration batch (plusieurs panoramiques)
- [ ] Export des descriptions vers formats externes
- [ ] Syst√®me de notation et feedback utilisateur

---

**Derni√®re mise √† jour** : 14 octobre 2025 - Build 2584  
**Auteur** : GitHub Copilot & √©quipe EditeurPanovisu
