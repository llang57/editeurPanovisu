name: ğŸš€ Build Multi-Platform Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 3.3.2)'
        required: true
        default: '3.3.2'

jobs:
  build-windows:
    name: ğŸªŸ Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: ğŸ› ï¸ Install Inno Setup
        run: |
          choco install innosetup -y
          Write-Host "âœ… Inno Setup installÃ©"
        shell: pwsh
      
      - name: ğŸ“ Create api-keys.properties
        run: |
          Copy-Item api-keys.properties.template api-keys.properties
          Write-Host "âœ… api-keys.properties crÃ©Ã© depuis template"
        shell: pwsh
      
      - name: ğŸ”¨ Build with Maven
        run: mvn clean package -DskipTests "-Dskip.build.increment=true"
        shell: pwsh
      
      - name: ğŸ“¦ Create Windows Installer
        run: .\build-installer.ps1
        shell: pwsh
      
      - name: ğŸ“Š Calculate SHA256
        id: sha256
        run: |
          $hash = (Get-FileHash target\installer\EditeurPanovisu-Setup-*.exe -Algorithm SHA256).Hash
          echo "HASH=$hash" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: ğŸ“¤ Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: target/installer/*.exe
          retention-days: 30

  build-macos:
    name: ğŸ macOS Installer
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: ï¿½ Create api-keys.properties
        run: |
          cp api-keys.properties.template api-keys.properties
          echo "âœ… api-keys.properties crÃ©Ã© depuis template"
      
      - name: ï¿½ï¸ Convert icon to .icns
        run: |
          # CrÃ©er l'icÃ´ne macOS si elle n'existe pas
          if [ ! -f "images/panovisu.icns" ]; then
            echo "âš ï¸  IcÃ´ne .icns manquante, crÃ©ation d'un placeholder"
            # On utilise l'icÃ´ne PNG comme fallback
            cp images/panovisu.png images/panovisu.icns || true
          fi
      
      - name: ğŸ”¨ Build with Maven
        run: mvn clean package -DskipTests -Dskip.build.increment=true
      
      - name: ğŸ“¦ Create macOS DMG
        run: |
          APP_VERSION="${{ github.event.inputs.version || '3.3.2' }}"
          
          # Trouver le nom exact du JAR
          MAIN_JAR=$(ls target/editeurPanovisu-*-SNAPSHOT.jar | xargs basename)
          echo "ğŸ“¦ JAR trouvÃ©: $MAIN_JAR"
          
          jpackage \
            --type dmg \
            --name EditeurPanovisu \
            --app-version "$APP_VERSION" \
            --vendor "PanoVisu" \
            --input target \
            --main-jar "$MAIN_JAR" \
            --main-class editeurpanovisu.EditeurPanovisu \
            --runtime-image "$JAVA_HOME" \
            --dest target/installer \
            --mac-package-name EditeurPanovisu \
            --mac-package-identifier fr.panovisu.editeur \
            --java-options "-Xmx2048m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --verbose || {
              echo "âŒ Erreur jpackage, essai sans icÃ´ne..."
              jpackage \
                --type dmg \
                --name EditeurPanovisu \
                --app-version "$APP_VERSION" \
                --vendor "PanoVisu" \
                --input target \
                --main-jar "$MAIN_JAR" \
                --main-class editeurpanovisu.EditeurPanovisu \
                --runtime-image "$JAVA_HOME" \
                --dest target/installer \
                --mac-package-name EditeurPanovisu \
                --mac-package-identifier fr.panovisu.editeur \
                --java-options "-Xmx2048m" \
                --java-options "-Dfile.encoding=UTF-8"
            }
      
      - name: ğŸ“Š Calculate SHA256
        id: sha256
        run: |
          HASH=$(shasum -a 256 target/installer/*.dmg | cut -d ' ' -f 1)
          echo "HASH=$HASH" >> $GITHUB_OUTPUT
      
      - name: ğŸ“¤ Upload macOS Installer
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: target/installer/*.dmg
          retention-days: 30

  build-linux-portable:
    name: ğŸ§ Linux Portable Archive
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: ğŸ“ Create api-keys.properties
        run: |
          Copy-Item api-keys.properties.template api-keys.properties
          Write-Host "api-keys.properties cree depuis template"
        shell: pwsh
      
      - name: ğŸ”¨ Build with Maven
        run: mvn clean package -DskipTests "-Dskip.build.increment=true"
        shell: pwsh
      
      - name: ğŸ“¦ Create Linux Portable Archive
        run: .\create-linux-portable.ps1
        shell: pwsh
      
      - name: ğŸ“Š Calculate SHA256
        id: sha256
        run: |
          $zipHash = (Get-FileHash target\EditeurPanovisu-Linux-Portable-*.zip -Algorithm SHA256).Hash
          $tarHash = (Get-FileHash target\EditeurPanovisu-Linux-Portable-*.tar.gz -Algorithm SHA256).Hash
          echo "ZIP_HASH=$zipHash" >> $env:GITHUB_OUTPUT
          echo "TAR_HASH=$tarHash" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: ğŸ“¤ Upload Linux Portable Archives
        uses: actions/upload-artifact@v4
        with:
          name: linux-portable
          path: |
            target/EditeurPanovisu-Linux-Portable-*.zip
            target/EditeurPanovisu-Linux-Portable-*.tar.gz
          retention-days: 30

  create-release:
    name: ğŸ‰ Create GitHub Release
    needs: [build-windows, build-macos, build-linux-portable]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts/windows
      
      - name: ğŸ“¥ Download macOS Installer
        uses: actions/download-artifact@v4
        with:
          name: macos-installer
          path: ./artifacts/macos
      
      - name: ğŸ“¥ Download Linux Portable Archive
        uses: actions/download-artifact@v4
        with:
          name: linux-portable
          path: ./artifacts/linux-portable
      
      - name: ï¿½ğŸ“Š Generate checksums
        id: checksums
        run: |
          echo "# ğŸ“Š SHA256 Checksums" > checksums.txt
          echo "" >> checksums.txt
          
          for file in artifacts/**/*; do
            if [ -f "$file" ]; then
              HASH=$(sha256sum "$file" | cut -d ' ' -f 1)
              FILENAME=$(basename "$file")
              echo "$HASH  $FILENAME" >> checksums.txt
            fi
          done
          
          cat checksums.txt
      
      - name: ğŸ“ Extract build number and version
        id: build_info
        run: |
          # Extraire le numÃ©ro de build depuis le fichier Java Properties
          BUILD_NUM=$(grep '^build\.number=' build.num 2>/dev/null | cut -d'=' -f2 || echo "unknown")
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "âœ… Build number: $BUILD_NUM"
          
          # DÃ©terminer la version (depuis le tag ou depuis l'input)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="v${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version: $VERSION"
      
      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.build_info.outputs.VERSION }}
          name: "EditeurPanovisu ${{ steps.build_info.outputs.VERSION }} - Build ${{ steps.build_info.outputs.BUILD_NUM }}"
          body: |
            ## ğŸ§ EditeurPanovisu ${{ github.ref_name }} - Support Linux Portable AmÃ©liorÃ©
            
            **Build** : ${{ steps.build_info.outputs.BUILD_NUM }}  
            **PrioritÃ©** : ï¿½ Archive portable Linux + ğŸ”§ Corrections bugs Linux + ï¿½ Documentation complÃ¨te
            
            ### ğŸ§ NouveautÃ©s v3.3.3 - Distribution Linux SimplifiÃ©e
            
            **Archive portable Linux** ğŸ“¦
            - âœ… **ZIP et TAR.GZ** : Archives complÃ¨tes autonomes sans dÃ©pendances systÃ¨me
            - ğŸ“ **Documentation triple** : INSTALLATION.md (Markdown), .txt (texte), .html (web stylisÃ©)
            - ğŸš€ **Script de lancement** : DÃ©tection automatique Java, vÃ©rification version, configuration JavaFX 3D
            - ğŸ“ **Structure propre** : Tous les fichiers Windows (.bat/.vbs) exclus
            - ï¿½ **Installation simple** : Extraire, chmod +x, lancer - aucune installation systÃ¨me requise
            
            **Corrections Linux** ğŸ›
            - âœ… **Cache panoramas** : Correction utilisation cache (700ms â†’ <50ms au chargement)
            - âœ… **Blocage modal** : FenÃªtre configuration ne bloque plus sous Linux
            - âœ… **NullPointerException** : Protection contre crashes au rechargement projet
            - âœ… **Build Maven** : Toutes les classes incluses dans le JAR (93/93)
            
            **Optimisations WebGL** ğŸ®
            - Filtrage trilinÃ©aire (LinearMipmapLinearFilter) pour nettetÃ© Ã  toutes distances
            - Anisotropie dynamique basÃ©e sur capacitÃ©s GPU (jusqu'Ã  16Ã—)
            - Mipmaps automatiques pour rendu optimal
            - DÃ©tection compression temps rÃ©el avec logs dÃ©taillÃ©s
            
            **QualitÃ© JPEG augmentÃ©e** ğŸ“¸
            - Panoramas Ã©qui : 70% â†’ 90% (niveaux), 95% (principal)
            - Panoramas cubes : 70% â†’ 88% (niveaux), 92% (principal)
            - Sharpening optimisÃ© (0.15-0.2) pour nettetÃ© sans artefacts
            
            **Outils de diagnostic inclus** ğŸ› ï¸
            - `diagnostic-webgl.html` : Test capacitÃ©s GPU navigateur
            - `test-compression.php` : VÃ©rification compression serveur
            - `.htaccess` prÃ©-configurÃ© pour Ã©viter compression automatique
            
            ### ğŸ¯ Visualiseur Panoramique 3D Haute QualitÃ©
            
            **Interface modernisÃ©e avec icÃ´nes** ğŸ¨
            - Boutons icÃ´nes intuitifs (home, photo, boussole, Å“il)
            - Adaptation automatique au thÃ¨me clair/sombre
            - Mode plein Ã©cran haute rÃ©solution (popup 1200Ã—780)
            
            **QualitÃ© d'affichage multipliÃ©e par 4** ğŸš€
            - Faces de cube : 500Ã—500 â†’ 1000Ã—1000 pixels
            - PrÃ©servation parfaite des panoramas 8192Ã—4096
            - Performances GPU : traitement total < 500ms
            
            ### ğŸ—ºï¸ Refonte Carte et GÃ©olocalisation
            
            **Migration vers Leaflet** ï¿½
            - Remplacement de NavigateurCarteGluon (bugs crashes)
            - Architecture lazy loading avec callbacks anti-bugs JavaFX
            - Marqueurs draggables dÃ©plaÃ§ables Ã  la souris
            - Radar champ de vision configurable 0-240m (Ã—3 vs ancien)
            
            **GÃ©ocodage amÃ©liorÃ©** ğŸ“
            - Recherche d'adresse via Nominatim OpenStreetMap
            - API complÃ¨te : ajouteMarqueur(), afficheRadar(), allerCoordonnees()
            - Chargement asynchrone pour interface rÃ©active
            
            ### âš¡ AccÃ©lÃ©ration GPU (OpenCL)
            
            - ğŸ® **Traitement GPU** : AccÃ©lÃ©ration matÃ©rielle pour toutes les opÃ©rations de traitement d'images
            - ğŸ“Š **Performances** : 
              - Chargement des visites : **3.4Ã— plus rapide** (15s â†’ 4.5s)
              - Affichage Ã  l'Ã©cran : **10Ã— plus rapide** (1000ms â†’ 100ms)
              - Redimensionnement batch : **1.7Ã— plus rapide**
            - ğŸ¨ **QualitÃ© d'image** : Interpolation Bicubic/Lanczos3 Ã©limine le crÃ©nelage
            - ğŸ”„ **Fallback automatique** : Bascule sur CPU si GPU indisponible
            
            **Support GPU**
            - Compatible OpenCL 1.2+ (NVIDIA CUDA, AMD ROCm, Intel)
            - Auto-routing intelligent GPU/CPU selon taille d'image
            - Gestion robuste des colorspaces (CMYK, YCbCr, RGB)
            
            ### ğŸ¨ SystÃ¨me de thÃ¨mes enrichi
            
            **24 thÃ¨mes disponibles**
            - 9 thÃ¨mes AtlantaFX (Primer Light/Dark, Nord Light/Dark, Cupertino Light/Dark, Dracula, Mocha, Gruvbox)
            - 2 thÃ¨mes MaterialFX (Light/Dark)
            - 2 thÃ¨mes FlatLaf (Light/Dark)
            - 2 thÃ¨mes Legacy (Clair/FoncÃ©)
            - 2 thÃ¨mes AcidulÃ©s (Clair/FoncÃ©)
            - 2 thÃ¨mes Modernes (Clair/FoncÃ©)
            - 8 thÃ¨mes Minimalistes (Bleu/Vert/Rouge/Mauve - Clair/FoncÃ©)
            
            **IcÃ´nes dynamiques colorÃ©es** ğŸ¨
            - Les icÃ´nes SVG prennent automatiquement la couleur du thÃ¨me
            - Conversion PNG dynamique avec Apache Batik
            - VisibilitÃ© optimisÃ©e thÃ¨mes sombres
            
            ### ğŸ“¥ TÃ©lÃ©chargements
            
            | Plateforme | Fichier | Taille | Notes |
            |------------|---------|--------|-------|
            | ğŸªŸ **Windows 10/11** | `EditeurPanovisu-Setup-3.3.3.exe` | ~188 MB | Installeur automatique |
            | ğŸ **macOS 11+** | `EditeurPanovisu-3.3.3.dmg` | ~200 MB | Image disque |
            | ğŸ§ **Linux** | `EditeurPanovisu-Linux-Portable-3.3.3.zip` | ~150 MB | â­ **RecommandÃ©** |
            | ğŸ§ **Linux** | `EditeurPanovisu-Linux-Portable-3.3.3.tar.gz` | ~145 MB | Alternative TAR |
            
            ğŸ“– **Installation Linux** : Consultez [INSTALLATION.md](https://github.com/llang57/editeurPanovisu/blob/master/doc/install/INSTALLATION.md) pour le guide complet
            
            ### âš ï¸ Versions prÃ©cÃ©dentes
            
            **v3.3.2** : QualitÃ© images optimale en ligne (WebGL, compression, diagnostic)  
            **v3.3.1** : SystÃ¨me de thÃ¨mes enrichi (24 thÃ¨mes, icÃ´nes dynamiques colorÃ©es)  
            **v3.3.0** : AccÃ©lÃ©ration GPU OpenCL, performances 3-10Ã— amÃ©liorÃ©es  
            **v3.2.0** : Personnalisation avancÃ©e des hotspots (16 animations, couleurs, icÃ´nes personnalisÃ©es)  
            **v3.1.0** : Correction critique case-sensitivity pour serveurs Linux  
            **v3.0.0** : Intelligence artificielle (Ollama), gÃ©nÃ©ration de descriptions automatiques
            
            ### ğŸ“‹ Configuration requise
            
            - **Windows** : Windows 10/11 64-bit
            - **macOS** : macOS 11 Big Sur ou supÃ©rieur
            - **Linux** : Debian 11+, Ubuntu 20.04+, Fedora 35+
            - **RAM** : 4 GB minimum, 8 GB recommandÃ©
            - **GPU** : Optionnel - OpenCL 1.2+ pour accÃ©lÃ©ration (NVIDIA, AMD, Intel)
            - **Disque** : 500 MB d'espace libre
            
            âš ï¸ **Java runtime inclus** - Aucune installation Java sÃ©parÃ©e requise !
            
            ### ğŸ”§ Installation
            
            #### Windows
            1. TÃ©lÃ©chargez `EditeurPanovisu-Setup-3.3.2.exe`
            2. Double-cliquez pour installer
            3. Suivez l'assistant d'installation
            4. Lancez via le raccourci Bureau ou Menu DÃ©marrer
            
            #### macOS
            1. TÃ©lÃ©chargez `EditeurPanovisu-3.3.2.dmg`
            2. Ouvrez le fichier `.dmg`
            3. Glissez l'icÃ´ne vers le dossier Applications
            4. Lancez depuis le Launchpad
            
            #### Linux (Debian/Ubuntu)
            ```bash
            sudo dpkg -i editeurpanovisu_3.3.2-1_amd64.deb
            # ou
            sudo apt install ./editeurpanovisu_3.3.2-1_amd64.deb
            ```
            
            #### Linux (RedHat/Fedora)
            ```bash
            sudo rpm -i editeurpanovisu-3.3.2-1.x86_64.rpm
            # ou
            sudo dnf install ./editeurpanovisu-3.3.2-1.x86_64.rpm
            ```
            
            ### ğŸ” VÃ©rification d'intÃ©gritÃ©
            
            Checksums SHA256 disponibles dans le fichier `checksums.txt` joint.
            
            ### ğŸ“š Documentation
            
            - [Guide d'installation](doc/installation/INSTALLATION_UTILISATEUR.md)
            - [Documentation complÃ¨te](doc/README.md)
            - [Configuration API](doc/guides/CONFIGURATION_API_KEYS.md)
            
            ### ğŸ™ Remerciements
            
            Merci Ã  tous les contributeurs et testeurs !
          files: |
            artifacts/windows/*
            artifacts/macos/*
            artifacts/linux-portable/*
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-summary:
    name: ğŸ“Š Build Summary
    needs: [build-windows, build-macos, build-linux-portable]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "# ğŸ‰ Build Multi-Platform Completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Windows** installer created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **macOS** installer created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Linux** portable archives created (ZIP + TAR.GZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ All artifacts ready for download!" >> $GITHUB_STEP_SUMMARY
