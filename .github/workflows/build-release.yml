name: ðŸš€ Build Multi-Platform Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 3.2.0)'
        required: true
        default: '3.2.0'

jobs:
  build-windows:
    name: ðŸªŸ Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: ðŸ› ï¸ Install Inno Setup
        run: |
          choco install innosetup -y
          Write-Host "âœ… Inno Setup installÃ©"
        shell: pwsh
      
      - name: ðŸ“ Create api-keys.properties
        run: |
          Copy-Item api-keys.properties.template api-keys.properties
          Write-Host "âœ… api-keys.properties crÃ©Ã© depuis template"
        shell: pwsh
      
      - name: ðŸ”¨ Build with Maven
        run: mvn clean package -DskipTests "-Dskip.build.increment=true"
        shell: pwsh
      
      - name: ðŸ“¦ Create Windows Installer
        run: .\build-installer.ps1
        shell: pwsh
      
      - name: ðŸ“Š Calculate SHA256
        id: sha256
        run: |
          $hash = (Get-FileHash target\installer\EditeurPanovisu-Setup-*.exe -Algorithm SHA256).Hash
          echo "HASH=$hash" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: ðŸ“¤ Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: target/installer/*.exe
          retention-days: 30

  build-macos:
    name: ðŸŽ macOS Installer
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: ï¿½ Create api-keys.properties
        run: |
          cp api-keys.properties.template api-keys.properties
          echo "âœ… api-keys.properties crÃ©Ã© depuis template"
      
      - name: ï¿½ï¸ Convert icon to .icns
        run: |
          # CrÃ©er l'icÃ´ne macOS si elle n'existe pas
          if [ ! -f "images/panovisu.icns" ]; then
            echo "âš ï¸  IcÃ´ne .icns manquante, crÃ©ation d'un placeholder"
            # On utilise l'icÃ´ne PNG comme fallback
            cp images/panovisu.png images/panovisu.icns || true
          fi
      
      - name: ðŸ”¨ Build with Maven
        run: mvn clean package -DskipTests -Dskip.build.increment=true
      
      - name: ðŸ“¦ Create macOS DMG
        run: |
          APP_VERSION="${{ github.event.inputs.version || '3.1.0' }}"
          
          # Trouver le nom exact du JAR
          MAIN_JAR=$(ls target/editeurPanovisu-*-SNAPSHOT.jar | xargs basename)
          echo "ðŸ“¦ JAR trouvÃ©: $MAIN_JAR"
          
          jpackage \
            --type dmg \
            --name EditeurPanovisu \
            --app-version "$APP_VERSION" \
            --vendor "PanoVisu" \
            --input target \
            --main-jar "$MAIN_JAR" \
            --main-class editeurpanovisu.EditeurPanovisu \
            --runtime-image "$JAVA_HOME" \
            --dest target/installer \
            --mac-package-name EditeurPanovisu \
            --mac-package-identifier fr.panovisu.editeur \
            --java-options "-Xmx2048m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --verbose || {
              echo "âŒ Erreur jpackage, essai sans icÃ´ne..."
              jpackage \
                --type dmg \
                --name EditeurPanovisu \
                --app-version "$APP_VERSION" \
                --vendor "PanoVisu" \
                --input target \
                --main-jar "$MAIN_JAR" \
                --main-class editeurpanovisu.EditeurPanovisu \
                --runtime-image "$JAVA_HOME" \
                --dest target/installer \
                --mac-package-name EditeurPanovisu \
                --mac-package-identifier fr.panovisu.editeur \
                --java-options "-Xmx2048m" \
                --java-options "-Dfile.encoding=UTF-8"
            }
      
      - name: ðŸ“Š Calculate SHA256
        id: sha256
        run: |
          HASH=$(shasum -a 256 target/installer/*.dmg | cut -d ' ' -f 1)
          echo "HASH=$HASH" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¤ Upload macOS Installer
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: target/installer/*.dmg
          retention-days: 30

  build-linux:
    name: ðŸ§ Linux Installers
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: ï¿½ Create api-keys.properties
        run: |
          cp api-keys.properties.template api-keys.properties
          echo "âœ… api-keys.properties crÃ©Ã© depuis template"
      
      - name: ï¿½ðŸ“¦ Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot rpm
      
      - name: ðŸ”¨ Build with Maven
        run: mvn clean package -DskipTests -Dskip.build.increment=true
      
      - name: ðŸ“¦ Create Debian Package (.deb)
        run: |
          APP_VERSION="${{ github.event.inputs.version || '3.2.0' }}"
          
          # Trouver le nom exact du JAR
          MAIN_JAR=$(ls target/editeurPanovisu-*-SNAPSHOT.jar | xargs basename)
          echo "ðŸ“¦ JAR trouvÃ©: $MAIN_JAR"
          
          jpackage \
            --type deb \
            --name editeurpanovisu \
            --app-version "$APP_VERSION" \
            --vendor "PanoVisu" \
            --icon images/panovisu.png \
            --input target \
            --main-jar "$MAIN_JAR" \
            --main-class editeurpanovisu.EditeurPanovisu \
            --runtime-image "$JAVA_HOME" \
            --dest target/installer \
            --linux-package-name editeurpanovisu \
            --linux-app-category "Graphics" \
            --linux-shortcut \
            --linux-menu-group "Graphics" \
            --java-options "-Xmx2048m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --verbose
      
      - name: ðŸ“¦ Create RPM Package (.rpm)
        run: |
          APP_VERSION="${{ github.event.inputs.version || '3.2.0' }}"
          
          # Trouver le nom exact du JAR
          MAIN_JAR=$(ls target/editeurPanovisu-*-SNAPSHOT.jar | xargs basename)
          echo "ðŸ“¦ JAR trouvÃ©: $MAIN_JAR"
          
          jpackage \
            --type rpm \
            --name editeurpanovisu \
            --app-version "$APP_VERSION" \
            --vendor "PanoVisu" \
            --icon images/panovisu.png \
            --input target \
            --main-jar "$MAIN_JAR" \
            --main-class editeurpanovisu.EditeurPanovisu \
            --runtime-image "$JAVA_HOME" \
            --dest target/installer \
            --linux-package-name editeurpanovisu \
            --linux-app-category "Graphics" \
            --linux-shortcut \
            --linux-menu-group "Graphics" \
            --java-options "-Xmx2048m" \
            --java-options "-Dfile.encoding=UTF-8" \
            --verbose
      
      - name: ðŸ“Š Calculate SHA256
        id: sha256
        run: |
          echo "### ðŸ“Š Checksums" >> $GITHUB_STEP_SUMMARY
          for file in target/installer/*.{deb,rpm}; do
            if [ -f "$file" ]; then
              HASH=$(sha256sum "$file" | cut -d ' ' -f 1)
              FILENAME=$(basename "$file")
              echo "- **$FILENAME**: \`$HASH\`" >> $GITHUB_STEP_SUMMARY
              echo "SHA256_$(echo $FILENAME | tr '.-' '_')=$HASH" >> $GITHUB_OUTPUT
            fi
          done
      
      - name: ðŸ“¤ Upload Linux Installers
        uses: actions/upload-artifact@v4
        with:
          name: linux-installers
          path: |
            target/installer/*.deb
            target/installer/*.rpm
          retention-days: 30

  create-release:
    name: ðŸŽ‰ Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts/windows
      
      - name: ðŸ“¥ Download macOS Installer
        uses: actions/download-artifact@v4
        with:
          name: macos-installer
          path: ./artifacts/macos
      
      - name: ðŸ“¥ Download Linux Installers
        uses: actions/download-artifact@v4
        with:
          name: linux-installers
          path: ./artifacts/linux
      
      - name: ðŸ“Š Generate checksums
        id: checksums
        run: |
          echo "# ðŸ“Š SHA256 Checksums" > checksums.txt
          echo "" >> checksums.txt
          
          for file in artifacts/**/*; do
            if [ -f "$file" ]; then
              HASH=$(sha256sum "$file" | cut -d ' ' -f 1)
              FILENAME=$(basename "$file")
              echo "$HASH  $FILENAME" >> checksums.txt
            fi
          done
          
          cat checksums.txt
      
      - name: ðŸ“ Extract build number and version
        id: build_info
        run: |
          # Extraire le numÃ©ro de build depuis le fichier Java Properties
          BUILD_NUM=$(grep '^build\.number=' build.num 2>/dev/null | cut -d'=' -f2 || echo "unknown")
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "âœ… Build number: $BUILD_NUM"
          
          # DÃ©terminer la version (depuis le tag ou depuis l'input)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="v${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version: $VERSION"
      
      - name: ðŸŽ‰ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.build_info.outputs.VERSION }}
          name: "EditeurPanovisu ${{ steps.build_info.outputs.VERSION }} - Build ${{ steps.build_info.outputs.BUILD_NUM }}"
          body: |
            ## ðŸ”§ EditeurPanovisu ${{ github.ref_name }} - Nouveaux outils
            
            **Build** : ${{ steps.build_info.outputs.BUILD_NUM }}  
            **PrioritÃ©** : âœ¨ Nouvelles fonctionnalitÃ©s
            
            ### âœ¨ NouveautÃ©s v3.2.0
            
            **Nouvelles fonctionnalitÃ©s**
            
            - ðŸ“¦ **Export ZIP** : Exportez vos visites directement en archive ZIP pour un partage simplifiÃ©
            - ðŸ–¼ï¸ **Redimensionnement d'images** : Nouvel outil de redimensionnement et compression des images panoramiques
            - ðŸ“ **Conversion ratio 2:1** : AmÃ©liorations du positionnement des icÃ´nes dans l'interface
            
            ### âš ï¸ Important - Migration depuis v3.0.0
            
            Si vous hÃ©bergez des visites sur des serveurs Linux, notez que la **v3.1.0** a corrigÃ© un problÃ¨me critique de case-sensitivity. Les visites crÃ©Ã©es avec v3.0.0 et hÃ©bergÃ©es sur Linux doivent Ãªtre rÃ©-exportÃ©es avec v3.1.0 ou supÃ©rieure.
            
            ### ðŸ“¥ TÃ©lÃ©chargements
            
            | Plateforme | Fichier | Taille |
            |------------|---------|--------|
            | ðŸªŸ **Windows 10/11** | `EditeurPanovisu-Setup-3.2.0.exe` | ~188 MB |
            | ðŸŽ **macOS 11+** | `EditeurPanovisu-3.2.0.dmg` | ~200 MB |
            | ðŸ§ **Linux (Debian/Ubuntu)** | `editeurpanovisu_3.2.0-1_amd64.deb` | ~180 MB |
            | ðŸ§ **Linux (RedHat/Fedora)** | `editeurpanovisu-3.2.0-1.x86_64.rpm` | ~180 MB |
            
            ### ðŸ“‹ Configuration requise
            
            - **Windows** : Windows 10/11 64-bit
            - **macOS** : macOS 11 Big Sur ou supÃ©rieur
            - **Linux** : Debian 11+, Ubuntu 20.04+, Fedora 35+
            - **RAM** : 4 GB minimum, 8 GB recommandÃ©
            - **Disque** : 500 MB d'espace libre
            
            âš ï¸ **Java runtime inclus** - Aucune installation Java sÃ©parÃ©e requise !
            
            ### ðŸ”§ Installation
            
            #### Windows
            1. TÃ©lÃ©chargez `EditeurPanovisu-Setup-3.2.0.exe`
            2. Double-cliquez pour installer
            3. Suivez l'assistant d'installation
            4. Lancez via le raccourci Bureau ou Menu DÃ©marrer
            
            #### macOS
            1. TÃ©lÃ©chargez `EditeurPanovisu-3.2.0.dmg`
            2. Ouvrez le fichier `.dmg`
            3. Glissez l'icÃ´ne vers le dossier Applications
            4. Lancez depuis le Launchpad
            
            #### Linux (Debian/Ubuntu)
            ```bash
            sudo dpkg -i editeurpanovisu_3.2.0-1_amd64.deb
            # ou
            sudo apt install ./editeurpanovisu_3.2.0-1_amd64.deb
            ```
            
            #### Linux (RedHat/Fedora)
            ```bash
            sudo rpm -i editeurpanovisu-3.2.0-1.x86_64.rpm
            # ou
            sudo dnf install ./editeurpanovisu-3.2.0-1.x86_64.rpm
            ```
            
            ### ðŸ” VÃ©rification d'intÃ©gritÃ©
            
            Checksums SHA256 disponibles dans le fichier `checksums.txt` joint.
            
            ### ðŸ“š Documentation
            
            - [Guide d'installation](doc/installation/INSTALLATION_UTILISATEUR.md)
            - [Documentation complÃ¨te](doc/README.md)
            - [Configuration API](doc/guides/CONFIGURATION_API_KEYS.md)
            
            ### ðŸ™ Remerciements
            
            Merci Ã  tous les contributeurs et testeurs !
          files: |
            artifacts/windows/*
            artifacts/macos/*
            artifacts/linux/*
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-summary:
    name: ðŸ“Š Build Summary
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸŽ‰ Build Multi-Platform Completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Windows** installer created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **macOS** installer created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Linux** installers created (DEB + RPM)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ All artifacts ready for download!" >> $GITHUB_STEP_SUMMARY
