name: ðŸ“š GÃ©nÃ©rer et publier la documentation Doxygen

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**/*.java'
      - 'panovisu/**/*.js'
      - 'doc/doxygen/Doxyfile'
      - '.github/workflows/docs.yml'
  workflow_dispatch:
    inputs:
      force:
        description: 'Forcer la publication'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ”§ Installer Doxygen et Graphviz
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
        doxygen --version
    
    - name: ðŸ“š GÃ©nÃ©rer la documentation Doxygen
      run: |
        cd doc/doxygen
        doxygen Doxyfile
        
        # VÃ©rifier que la gÃ©nÃ©ration a rÃ©ussi
        if [ ! -f "html/index.html" ]; then
          echo "âŒ Erreur : La documentation n'a pas Ã©tÃ© gÃ©nÃ©rÃ©e !"
          exit 1
        fi
        
        # CrÃ©er .nojekyll pour dÃ©sactiver Jekyll
        touch html/.nojekyll
        
        # Afficher les statistiques
        echo "ðŸ“Š Statistiques de la documentation :"
        echo "   - Fichiers HTML : $(find html -name '*.html' | wc -l)"
        echo "   - Taille totale : $(du -sh html | cut -f1)"
    
    - name: ðŸ“ CrÃ©er README pour gh-pages
      run: |
        cat > doc/doxygen/html/README.md << 'EOF'
        # ðŸ“– Documentation EditeurPanovisu
        
        Documentation technique gÃ©nÃ©rÃ©e automatiquement avec Doxygen.
        
        ## ðŸ”— AccÃ¨s
        
        **[ðŸ“š AccÃ©der Ã  la documentation](https://llang57.github.io/editeurPanovisu/)**
        
        ## ðŸ“Š Informations
        
        - **Projet** : EditeurPanovisu
        - **Version** : 3.0.0
        - **DerniÃ¨re mise Ã  jour** : $(date '+%d/%m/%Y Ã  %H:%M UTC')
        - **GÃ©nÃ©rateur** : Doxygen 1.14.0
        - **Langage** : Java + JavaScript
        
        ## ðŸ“ Contenu
        
        Cette documentation inclut :
        - Classes Java (package `editeurpanovisu`)
        - Code JavaScript (`panovisu.js`)
        - Fichiers d'internationalisation
        - Index et recherche intÃ©grÃ©s
        
        ## ðŸ”„ Mise Ã  jour
        
        Cette documentation est automatiquement rÃ©gÃ©nÃ©rÃ©e Ã  chaque commit sur la branche `master` qui modifie :
        - Les fichiers Java dans `src/`
        - Les fichiers JavaScript dans `panovisu/`
        - Le fichier `Doxyfile`
        
        ---
        
        *GÃ©nÃ©rÃ© automatiquement par GitHub Actions*
        EOF
    
    - name: ðŸš€ DÃ©ployer sur GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./doc/doxygen/html
        publish_branch: gh-pages
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: |
          docs: ðŸ“š Mise Ã  jour automatique de la documentation
          
          Mise Ã  jour de la documentation Doxygen
          Commit source: ${{ github.sha }}
          Date: $(date '+%d/%m/%Y %H:%M:%S UTC')
        force_orphan: true
    
    - name: âœ… Publication rÃ©ussie
      run: |
        echo "âœ… Documentation publiÃ©e avec succÃ¨s !"
        echo ""
        echo "ðŸ“– La documentation sera accessible dans quelques minutes Ã  :"
        echo "   https://llang57.github.io/editeurPanovisu/"
        echo ""
        echo "â±ï¸  DÃ©lai de propagation : 2-3 minutes"
