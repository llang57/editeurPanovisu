name: ðŸ“– GÃ©nÃ©rer et publier Javadoc

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**/*.java'
      - '.github/workflows/javadoc.yml'
  workflow_dispatch:
    inputs:
      force:
        description: 'Forcer la publication'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  generate-javadoc:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Configuration Java 25
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '25'
        cache: 'maven'
    
    - name: ðŸ“š GÃ©nÃ©rer Javadoc avec Maven
      run: |
        echo "ðŸ”§ GÃ©nÃ©ration de la Javadoc..."
        mvn javadoc:javadoc -DskipTests
        
        # VÃ©rifier que la gÃ©nÃ©ration a rÃ©ussi
        if [ ! -f "target/site/apidocs/index.html" ]; then
          echo "âŒ Erreur : La Javadoc n'a pas Ã©tÃ© gÃ©nÃ©rÃ©e !"
          exit 1
        fi
        
        # CrÃ©er .nojekyll pour dÃ©sactiver Jekyll
        touch target/site/apidocs/.nojekyll
        
        # Afficher les statistiques
        echo "ðŸ“Š Statistiques de la Javadoc :"
        echo "   - Fichiers HTML : $(find target/site/apidocs -name '*.html' | wc -l)"
        echo "   - Taille totale : $(du -sh target/site/apidocs | cut -f1)"
    
    - name: ðŸ“ CrÃ©er README pour gh-pages
      run: |
        cat > target/site/apidocs/README.md << 'EOF'
        # ðŸ“– Javadoc EditeurPanovisu
        
        Documentation API gÃ©nÃ©rÃ©e automatiquement avec Javadoc.
        
        ## ðŸ”— AccÃ¨s
        
        **[ðŸ“š AccÃ©der Ã  la Javadoc](https://llang57.github.io/editeurPanovisu/javadoc/)**
        
        ## ðŸ“Š Informations
        
        - **Projet** : EditeurPanovisu
        - **Version** : 3.3.2-SNAPSHOT
        - **DerniÃ¨re mise Ã  jour** : $(date '+%d/%m/%Y Ã  %H:%M UTC')
        - **GÃ©nÃ©rateur** : Javadoc (Maven)
        - **Langage** : Java 25
        
        ## ðŸ“ Contenu
        
        Cette Javadoc inclut :
        - Toutes les classes publiques du package `editeurpanovisu`
        - Classes GPU (`editeurpanovisu.gpu`)
        - Documentation complÃ¨te avec exemples d'utilisation
        - Index et recherche intÃ©grÃ©s
        
        ## ðŸ”„ Mise Ã  jour
        
        Cette documentation est automatiquement rÃ©gÃ©nÃ©rÃ©e Ã  chaque commit sur la branche `master` qui modifie les fichiers Java dans `src/`.
        
        ## ðŸŽ¯ QualitÃ©
        
        - âœ… 0 mÃ©thodes publiques principales sans documentation
        - âœ… 0 duplications de Javadoc
        - âœ… Documentation structurÃ©e avec exemples
        
        ---
        
        *GÃ©nÃ©rÃ© automatiquement par GitHub Actions*
        EOF
    
    - name: ðŸš€ DÃ©ployer sur GitHub Pages (sous-rÃ©pertoire javadoc)
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./target/site/apidocs
        destination_dir: javadoc
        publish_branch: gh-pages
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: |
          docs: ðŸ“– Mise Ã  jour automatique de la Javadoc
          
          Mise Ã  jour de la documentation Javadoc
          Commit source: ${{ github.sha }}
          Date: $(date '+%d/%m/%Y %H:%M:%S UTC')
        keep_files: true
    
    - name: âœ… Publication rÃ©ussie
      run: |
        echo "âœ… Javadoc publiÃ©e avec succÃ¨s !"
        echo ""
        echo "ðŸ“– La Javadoc sera accessible dans quelques minutes Ã  :"
        echo "   https://llang57.github.io/editeurPanovisu/javadoc/"
        echo ""
        echo "â±ï¸  DÃ©lai de propagation : 2-3 minutes"
        echo ""
        echo "ðŸ”— La documentation Doxygen reste accessible Ã  :"
        echo "   https://llang57.github.io/editeurPanovisu/"
