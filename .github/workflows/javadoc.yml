name: 📖 Générer et publier Javadoc

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**/*.java'
      - '.github/workflows/javadoc.yml'
  workflow_dispatch:
    inputs:
      force:
        description: 'Forcer la publication'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  generate-javadoc:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ☕ Configuration Java 25
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '25'
        cache: 'maven'
    
    - name: 📚 Générer Javadoc avec Maven
      run: |
        echo "🔧 Génération de la Javadoc..."
        mvn javadoc:javadoc -DskipTests
        
        # Détecter le répertoire de sortie
        if [ -d "target/site/apidocs" ]; then
          JAVADOC_DIR="target/site/apidocs"
        elif [ -d "target/apidocs" ]; then
          JAVADOC_DIR="target/apidocs"
        else
          echo "❌ Erreur : Aucun répertoire Javadoc trouvé !"
          find target -type d -name "apidocs" || echo "Aucun apidocs trouvé"
          exit 1
        fi
        
        echo "✅ Javadoc générée dans : $JAVADOC_DIR"
        
        # Vérifier que index.html existe
        if [ ! -f "$JAVADOC_DIR/index.html" ]; then
          echo "❌ Erreur : index.html manquant dans $JAVADOC_DIR"
          ls -la "$JAVADOC_DIR" || echo "Impossible de lister le répertoire"
          exit 1
        fi
        
        # Créer .nojekyll pour désactiver Jekyll
        touch "$JAVADOC_DIR/.nojekyll"
        
        # Afficher les statistiques
        echo "📊 Statistiques de la Javadoc :"
        echo "   - Fichiers HTML : $(find $JAVADOC_DIR -name '*.html' | wc -l)"
        echo "   - Taille totale : $(du -sh $JAVADOC_DIR | cut -f1)"
        
        # Sauvegarder le chemin pour les étapes suivantes
        echo "JAVADOC_DIR=$JAVADOC_DIR" >> $GITHUB_ENV
        
        # Copier dans un emplacement fixe pour le déploiement
        mkdir -p javadoc-output
        cp -r "$JAVADOC_DIR"/* javadoc-output/
    
    - name: 📝 Créer README pour gh-pages
      run: |
        cat > javadoc-output/README.md << 'EOF'
        # 📖 Javadoc EditeurPanovisu
        
        Documentation API générée automatiquement avec Javadoc.
        
        ## 🔗 Accès
        
        **[📚 Accéder à la Javadoc](https://llang57.github.io/editeurPanovisu/javadoc/)**
        
        ## 📊 Informations
        
        - **Projet** : EditeurPanovisu
        - **Version** : 3.3.2-SNAPSHOT
        - **Dernière mise à jour** : $(date '+%d/%m/%Y à %H:%M UTC')
        - **Générateur** : Javadoc (Maven)
        - **Langage** : Java 25
        
        ## 📁 Contenu
        
        Cette Javadoc inclut :
        - Toutes les classes publiques du package `editeurpanovisu`
        - Classes GPU (`editeurpanovisu.gpu`)
        - Documentation complète avec exemples d'utilisation
        - Index et recherche intégrés
        
        ## 🔄 Mise à jour
        
        Cette documentation est automatiquement régénérée à chaque commit sur la branche `master` qui modifie les fichiers Java dans `src/`.
        
        ## 🎯 Qualité
        
        - ✅ 0 méthodes publiques principales sans documentation
        - ✅ 0 duplications de Javadoc
        - ✅ Documentation structurée avec exemples
        
        ---
        
        *Généré automatiquement par GitHub Actions*
        EOF
    
    - name: 🚀 Déployer sur GitHub Pages (sous-répertoire javadoc)
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./javadoc-output
        destination_dir: javadoc
        publish_branch: gh-pages
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: |
          docs: 📖 Mise à jour automatique de la Javadoc
          
          Mise à jour de la documentation Javadoc
          Commit source: ${{ github.sha }}
          Date: $(date '+%d/%m/%Y %H:%M:%S UTC')
        keep_files: true
    
    - name: ✅ Publication réussie
      run: |
        echo "✅ Javadoc publiée avec succès !"
        echo ""
        echo "📖 La Javadoc sera accessible dans quelques minutes à :"
        echo "   https://llang57.github.io/editeurPanovisu/javadoc/"
        echo ""
        echo "⏱️  Délai de propagation : 2-3 minutes"
        echo ""
        echo "🔗 La documentation Doxygen reste accessible à :"
        echo "   https://llang57.github.io/editeurPanovisu/"
