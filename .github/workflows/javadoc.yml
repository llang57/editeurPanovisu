name: ğŸ“– GÃ©nÃ©rer et publier Javadoc

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**/*.java'
      - '.github/workflows/javadoc.yml'
  workflow_dispatch:
    inputs:
      force:
        description: 'Forcer la publication'
        required: false
        default: 'false'

permissions:
  contents: read
  pages: write
  id-token: write

# Permettre un seul dÃ©ploiement concurrent
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Configuration Java 25
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '25'
        cache: 'maven'
    
    - name: ğŸ“š GÃ©nÃ©rer Javadoc avec Maven
      run: |
        echo "ğŸ”§ GÃ©nÃ©ration de la Javadoc..."
        mvn javadoc:javadoc -DskipTests
        
        # DÃ©tecter le rÃ©pertoire de sortie
        if [ -d "target/reports/apidocs" ]; then
          JAVADOC_DIR="target/reports/apidocs"
        elif [ -d "target/site/apidocs" ]; then
          JAVADOC_DIR="target/site/apidocs"
        elif [ -d "target/apidocs" ]; then
          JAVADOC_DIR="target/apidocs"
        else
          echo "âŒ Erreur : Aucun rÃ©pertoire Javadoc trouvÃ© !"
          find target -type d -name "apidocs" || echo "Aucun apidocs trouvÃ©"
          exit 1
        fi
        
        echo "âœ… Javadoc gÃ©nÃ©rÃ©e dans : $JAVADOC_DIR"
        
        # VÃ©rifier que index.html existe
        if [ ! -f "$JAVADOC_DIR/index.html" ]; then
          echo "âŒ Erreur : index.html manquant dans $JAVADOC_DIR"
          exit 1
        fi
        
        # CrÃ©er .nojekyll pour dÃ©sactiver Jekyll
        touch "$JAVADOC_DIR/.nojekyll"
        
        # Afficher les statistiques
        echo "ğŸ“Š Statistiques de la Javadoc :"
        echo "   - Fichiers HTML : $(find $JAVADOC_DIR -name '*.html' | wc -l)"
        echo "   - Taille totale : $(du -sh $JAVADOC_DIR | cut -f1)"
        
        # Copier pour le dÃ©ploiement
        mkdir -p _site
        cp -r "$JAVADOC_DIR"/* _site/
        
        echo "âœ… Javadoc prÃªte pour le dÃ©ploiement dans _site/"
    
    - name: ï¿½ Upload artifact pour GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

  # Job de dÃ©ploiement
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸš€ DÃ©ployer sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: âœ… Publication rÃ©ussie
      run: |
        echo "âœ… Javadoc publiÃ©e avec succÃ¨s !"
        echo "ğŸ“– Accessible Ã  : ${{ steps.deployment.outputs.page_url }}"
